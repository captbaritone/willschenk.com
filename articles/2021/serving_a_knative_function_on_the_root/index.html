<!doctype html><html><head><title>Serving a knative function on the root</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet href=../../../css/theme.css><link rel=stylesheet href=../../../css/syntax.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-56296045-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script async defer data-domain=willschenk.com src=https://plausible.io/js/plausible.js></script><meta property="og:title" content="Serving a knative function on the root"><meta property="og:description" content="I want to deploy everything as a knative service, including the root of the domain.  Update: I found an easyier way. Easy way   Turn on auto-tls and autocreate-cluster-domain-claims: kubectl patch configmap config-network --namespace knative-serving -p '{&#34;data&#34;:{&#34;auto-tls&#34;:&#34;Enabled&#34;,&#34;autocreate-cluster-domain-claims&#34;:&#34;true&#34;}}'   Then kn domain create gitgratitude.com --ref=homepage   That's it. Hardway   Left here for the record. Add ingress-nginx  helm upgrade --install ingress-nginx ingress-nginx \  --repo https://kubernetes."><meta property="og:type" content="article"><meta property="og:url" content="https://willschenk.com/articles/2021/serving_a_knative_function_on_the_root/"><meta property="article:published_time" content="2021-12-01T00:00:00+00:00"><meta property="article:modified_time" content="2021-12-01T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Serving a knative function on the root"><meta name=twitter:description content="I want to deploy everything as a knative service, including the root of the domain.  Update: I found an easyier way. Easy way   Turn on auto-tls and autocreate-cluster-domain-claims: kubectl patch configmap config-network --namespace knative-serving -p '{&#34;data&#34;:{&#34;auto-tls&#34;:&#34;Enabled&#34;,&#34;autocreate-cluster-domain-claims&#34;:&#34;true&#34;}}'   Then kn domain create gitgratitude.com --ref=homepage   That's it. Hardway   Left here for the record. Add ingress-nginx  helm upgrade --install ingress-nginx ingress-nginx \  --repo https://kubernetes."><meta name=twitter:site content="@wschenk"><style>.article p,.article ul,.article ol,.article table{max-width:45em}.article pre p{max-width:none;margin-top:-1.5rem}article.article p:first-child,.article blockquote{font-size:1.25em;font-weight:300;max-width:36em}.half-height-scroll{max-height:32em;overflow:scroll}</style></head><body><nav class="container my-5"><h1 class="pt-md-5 display-3"><a class=text-dark href=../../../>Will Schenk</a></h1><p><a class="text-dark h4 mr-3 font-weight-light" href=../../../articles/>Articles</a>
<a class="text-dark h4 mr-3 font-weight-light" href=../../../contact>Contact</a>
<a class="text-dark h4 mr-3 font-weight-light" href=../../../tags/>Tags</a>
<a href=../../../feed.xml class="mr-3 h4 text-light"><img src=../../../img/rss.svg alt=rss height=20 width=20></a>
<a href=https://twitter.com/@wschenk class="mr-3 h4 text-light"><img src=../../../img/twitter.svg alt=twitter height=20 width=20></a>
<a href=https://instagram.com/wschenk class="mr-3 h4 text-light"><img src=../../../img/instagram.svg alt=instagram height=20 width=20></a>
<a href=https://github.com/wschenk class="mr-3 h4 text-light"><img src=../../../img/github.svg alt=github height=20 width=20></a>
<a href=https://linkedin.com/in/will-schenk-420266 class="mr-3 h4 text-light"><img src=../../../img/linkedin.svg alt=linkedin height=20 width=20></a></p></nav><div class=container><h1 class=mt-5>Serving a knative function on the root</h1><h2 class="font-weight-light font-italic mb-3">root to services</h2><p class="text-muted mt-3"><a class=text-muted href=https://willschenk.com/articles/2021/serving_a_knative_function_on_the_root/>Published December 1, 2021</a>
<a class=text-muted href=../../../tags/kubernetes>#kubernetes,</a>
<a class=text-muted href=../../../tags/knative>#knative,</a>
<a class=text-muted href=../../../tags/kourier>#kourier</a></p><article class="article mt-5"><p>I want to deploy everything as a knative service, including the root
of the domain.</p><p><strong>Update</strong>: I found an easyier way.</p><h2 id=headline-1>Easy way</h2><p>Turn on <code class=verbatim>auto-tls</code> and <code class=verbatim>autocreate-cluster-domain-claims</code>:</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>  kubectl patch configmap config-network --namespace knative-serving -p <span class=s1>&#39;{&#34;data&#34;:{&#34;auto-tls&#34;:&#34;Enabled&#34;,&#34;autocreate-cluster-domain-claims&#34;:&#34;true&#34;}}&#39;</span></code></pre></div></div><p>Then</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kn domain create gitgratitude.com --ref<span class=o>=</span>homepage</code></pre></div></div><p>That's it.</p><h2 id=headline-2>Hardway</h2><p>Left here for the record.</p><h2 id=headline-3>Add <code class=verbatim>ingress-nginx</code></h2><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>  helm upgrade --install ingress-nginx ingress-nginx <span class=se>\
</span><span class=se></span>       --repo https://kubernetes.github.io/ingress-nginx <span class=se>\
</span><span class=se></span>       --namespace ingress-nginx --create-namespace</code></pre></div></div><h2 id=headline-4>Configure <code class=verbatim>letsencrypt</code></h2><p>Make sure to change your email address</p><p><code class=verbatim>nginx-certs.yml:</code></p><div class="src src-yaml"><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>cert-manager.io/v1<span class=w>
</span><span class=w></span><span class=k>kind</span><span class=p>:</span><span class=w> </span>ClusterIssuer<span class=w>
</span><span class=w></span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>name</span><span class=p>:</span><span class=w> </span>letsencrypt-prod-nginx<span class=w>
</span><span class=w></span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>acme</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=c># You must replace this email address with your own.</span><span class=w>
</span><span class=w>    </span><span class=c># Let&#39;s Encrypt will use this to contact you about expiring</span><span class=w>
</span><span class=w>    </span><span class=c># certificates, and issues related to your account.</span><span class=w>
</span><span class=w>    </span><span class=k>email</span><span class=p>:</span><span class=w> </span>wschenk@gmail.com<span class=w>
</span><span class=w>    </span><span class=k>server</span><span class=p>:</span><span class=w> </span>https<span class=p>:</span>//acme-v02.api.letsencrypt.org/directory<span class=w>
</span><span class=w>    </span><span class=k>privateKeySecretRef</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=c># Secret resource that will be used to store the account&#39;s private key.</span><span class=w>
</span><span class=w>      </span><span class=k>name</span><span class=p>:</span><span class=w> </span>prod-issuer-account-key-nginx<span class=w>
</span><span class=w>    </span><span class=c># Add a single challenge solver, HTTP01 using nginx</span><span class=w>
</span><span class=w>    </span><span class=k>solvers</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>http01</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=k>ingress</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=k>class</span><span class=p>:</span><span class=w> </span>nginx</code></pre></div></div><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>  kubectl apply -f nginx-certs.yaml</code></pre></div></div><h2 id=headline-5>DNS</h2><h3 id=headline-6>Find the ip</h3><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>  kubectl --namespace ingress-nginx get service ingress-nginx-controller -o json<span class=p>|</span> jq <span class=s2>&#34;.status.loadBalancer.ingress[0].ip&#34;</span></code></pre></div></div><pre class=example>
&#34;137.184.240.185&#34;
</pre><h3 id=headline-7>Create DNS entry</h3><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>  doctl compute domain records create gitgratitude.com --record-type A --record-data 137.184.240.185 --record-name <span class=se>\@</span></code></pre></div></div><pre class=example>
ID           Type    Name    Data               Priority    Port    TTL     Weight
280663245    A       @       137.184.240.185    0           0       1800    0
</pre><h2 id=headline-8>Add a simple knative service</h2><p>We are setting the min scale to 1 so there's no startup time for this service.</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>  kubectl service create homepage --image gcr.io/knative-samples/homepage --scale-min <span class=m>1</span></code></pre></div></div><p>Which will result in this being deployed internally as
<a href=http://homepage.default.svc.cluster.local>http://homepage.default.svc.cluster.local</a></p><h2 id=headline-9>Simple reverse proxy service</h2><h3 id=headline-10>Code</h3><p>This is available on <a href=https://github.com/wschenk/proxy>https://github.com/wschenk/proxy</a></p><div class="src src-javascript"><div class=highlight><pre class=chroma><code class=language-javascript data-lang=javascript>  <span class=kr>const</span> <span class=nx>http</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;http&#39;</span><span class=p>);</span>
  <span class=kr>const</span> <span class=nx>httpProxy</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;http-proxy&#39;</span><span class=p>);</span>

  <span class=kr>const</span> <span class=nx>remote</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>REMOTE_TARGET</span> <span class=o>||</span> <span class=s2>&#34;http://homepage.default.svc.cluster.local&#34;</span><span class=p>;</span>

  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span> <span class=s2>&#34;Proxy starting up on port 3000&#34;</span> <span class=p>);</span>
  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span> <span class=sb>`Proxing to </span><span class=si>${</span><span class=nx>remote</span><span class=si>}</span><span class=sb>`</span> <span class=p>);</span>

  <span class=nx>httpProxy</span><span class=p>.</span><span class=nx>createProxyServer</span><span class=p>({</span>
      <span class=nx>target</span><span class=o>:</span> <span class=nx>remote</span><span class=p>,</span>
      <span class=nx>changeOrigin</span><span class=o>:</span> <span class=kc>true</span>
  <span class=p>}).</span><span class=nx>listen</span><span class=p>(</span><span class=mi>3000</span><span class=p>);</span>
</code></pre></div></div><p>I'm packaging this up at ghcr.io/wschenk/proxy</p><h3 id=headline-11>Setup the proxy service</h3><div class="src src-yaml"><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=w>  </span><span class=k>kind</span><span class=p>:</span><span class=w> </span>Deployment<span class=w>
</span><span class=w>  </span><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>apps/v1<span class=w>
</span><span class=w>  </span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>name</span><span class=p>:</span><span class=w> </span>homepage-proxy<span class=w>
</span><span class=w>  </span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>    </span><span class=k>selector</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=k>app</span><span class=p>:</span><span class=w> </span>homepage-proxy<span class=w>
</span><span class=w>    </span><span class=k>template</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=k>labels</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=k>app</span><span class=p>:</span><span class=w> </span>homepage-proxy<span class=w>
</span><span class=w>      </span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=k>containers</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>homepage-proxy<span class=w>
</span><span class=w>            </span><span class=k>image</span><span class=p>:</span><span class=w> </span>ghcr.io/wschenk/proxy<span class=w>
</span><span class=w>            </span><span class=k>imagePullPolicy</span><span class=p>:</span><span class=w> </span>Always<span class=w>
</span><span class=w>            </span><span class=k>ports</span><span class=p>:</span><span class=w>
</span><span class=w>              </span>- <span class=k>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>3000</span><span class=w>
</span><span class=w>                </span><span class=k>name</span><span class=p>:</span><span class=w> </span>http<span class=w>
</span><span class=w>            </span><span class=k>env</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>REMOTE_TARGET<span class=w>
</span><span class=w>              </span><span class=k>value</span><span class=p>:</span><span class=w> </span>http<span class=p>:</span>//homepage.default.svc.cluster.local<span class=w>
</span><span class=w>
</span><span class=w>  </span>--<span class=sd>-
</span><span class=sd>  apiVersion: v1</span><span class=w>
</span><span class=w>  </span><span class=k>kind</span><span class=p>:</span><span class=w> </span>Service<span class=w>
</span><span class=w>  </span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>name</span><span class=p>:</span><span class=w> </span>homepage-proxy<span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>ports</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=k>protocol</span><span class=p>:</span><span class=w> </span>TCP<span class=w>
</span><span class=w>        </span><span class=k>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>        </span><span class=k>targetPort</span><span class=p>:</span><span class=w> </span>http<span class=w>
</span><span class=w>    </span><span class=k>selector</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>app</span><span class=p>:</span><span class=w> </span>homepage-proxy</code></pre></div></div><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>  kubectl apply -f proxy.yaml</code></pre></div></div><pre class=example>
deployment.apps/homepage-proxy configured
service/homepage-proxy unchanged
</pre><h2 id=headline-12>Create <code class=verbatim>ingress.yaml</code></h2><p><code class=verbatim>ingress.yaml</code>:</p><div class="src src-yaml"><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=w>  </span><span class=k>apiVersion</span><span class=p>:</span><span class=w> </span>networking.k8s.io/v1<span class=w>
</span><span class=w>  </span><span class=k>kind</span><span class=p>:</span><span class=w> </span>Ingress<span class=w>
</span><span class=w>  </span><span class=k>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>name</span><span class=p>:</span><span class=w> </span>gitgratitude-root<span class=w>
</span><span class=w>    </span><span class=k>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=c># add an annotation indicating the issuer to use.</span><span class=w>
</span><span class=w>      </span><span class=k>cert-manager.io/cluster-issuer</span><span class=p>:</span><span class=w> </span>letsencrypt-prod-nginx<span class=w>
</span><span class=w>      </span><span class=k>kubernetes.io/tls-acme</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span><span class=w>  </span><span class=k>spec</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>ingressClassName</span><span class=p>:</span><span class=w> </span>nginx<span class=w>
</span><span class=w>    </span><span class=k>tls</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=k>hosts</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- gitgratitude.com<span class=w>
</span><span class=w>        </span><span class=k>secretName</span><span class=p>:</span><span class=w> </span>gratitude-root-tls<span class=w>
</span><span class=w>    </span><span class=k>rules</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=k>host</span><span class=p>:</span><span class=w> </span>gitgratitude.com<span class=w>
</span><span class=w>        </span><span class=k>http</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=k>paths</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=k>path</span><span class=p>:</span><span class=w> </span>/<span class=w>
</span><span class=w>              </span><span class=k>pathType</span><span class=p>:</span><span class=w> </span>Prefix<span class=w>
</span><span class=w>              </span><span class=k>backend</span><span class=p>:</span><span class=w>
</span><span class=w>                </span><span class=k>service</span><span class=p>:</span><span class=w>
</span><span class=w>                  </span><span class=k>name</span><span class=p>:</span><span class=w>  </span>homepage-proxy<span class=w>
</span><span class=w>                  </span><span class=k>port</span><span class=p>:</span><span class=w>
</span><span class=w>                    </span><span class=k>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span></code></pre></div></div><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>  kubectl apply -f ingress.yaml</code></pre></div></div><pre class=example>
ingress.networking.k8s.io/gitgratitude-root configured
</pre><h2 id=headline-13>Testing</h2><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kn service update helloworld-go --env <span class=nv>TARGET</span><span class=o>=</span><span class=s2>&#34;World&#34;</span></code></pre></div></div><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>  curl https://gitgratitude.com</code></pre></div></div><pre class=example>
Hello World!
</pre><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kn service update helloworld-go --env <span class=nv>TARGET</span><span class=o>=</span><span class=s2>&#34;from knative&#34;</span></code></pre></div></div><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>  curl https://gitgratitude.com</code></pre></div></div><pre class=example>
Hello from knative!
</pre><h2 id=headline-14>Conclusion</h2><p>The reverse proxy is a little bit weird, since we are proxying through
a couple of different layers, but this allows us to deploy everything
as a knative service.</p><h2 id=headline-15>References</h2><ol><li><p><a href=https://github.com/http-party/node-http-proxy#setup-a-basic-stand-alone-proxy-server>https://github.com/http-party/node-http-proxy#setup-a-basic-stand-alone-proxy-server</a></p></li><li><p><a href=https://www.starkandwayne.com/blog/public-traffic-into-knative-on-gke/>https://www.starkandwayne.com/blog/public-traffic-into-knative-on-gke/</a></p></li></ol></article></div><div class="bg-light py-5"><div class=container><h2 class=text-center>Read next</h2><div class=row><div class="col-md-6 text-center">Next Post:
<a href=../../../articles/2021/next_js_with_prisma/>NextJS with Prisma on Kubernetes</a></div><div class="col-md-6 text-center">Previous Post:
<a href=../../../articles/2021/setting_up_knative/>Setting up knative</a></div></div></div></div><div class="container mt-5"><h2 class=text-center>See also</h2><div class=row><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2021/setting_up_knative/>Setting up knative</a></p><p class="lead font-italic mb-0">functions functions functions</p><div class="font-weight-light mt-3"><p>Let's walk through how to setup a k8 cluster on digitalocean with knative. Digital Ocean Start the cluster Installing and configure the doctl tool. Then setup a cluster: doctl kubernetes cluster create gratitude \ --auto-upgrade \ "--node-pool=name=default;min-nodes=1;max-nodes=10;size=s-4vcpu-8gb;auto-scale=true" Once that's in place, make sure that you have a domain, in my case gitgratitude.com: doctl compute domain create gitgratitude.com Installing knative We are going to use the knative operator to setup the install.</p></div><a href=../../../articles/2021/setting_up_knative/ class="btn btn-primary">Read more</a></div><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2021/k8_dashboard_on_docker_desktop/>K8 Dashboard on Docker Desktop</a></p><p class="lead font-italic mb-0">what&rsquo;s going on</p><div class="font-weight-light mt-3"><p>Pretty easy to setup, but here are the steps. Docker Desktop To easily get going on a local Mac, you can install the compoents using homebrew. brew install --cask docker brew install kubernetes-cli brew install kn Start up Docker, and then turn on kubernetes and make sure that you have a running node. kubectl get nodes NAME STATUS ROLES AGE VERSION docker-desktop Ready control-plane,master 5h59m v1.</p></div><a href=../../../articles/2021/k8_dashboard_on_docker_desktop/ class="btn btn-primary">Read more</a></div><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2021/rails_on_kubernetes_with_tls/>Rails on Kubernetes with TLS</a></p><p class="lead font-italic mb-0">certmanager</p><div class="font-weight-light mt-3"><p>I wanted to see how to really use kubernetes like I'm used to using heroku, so lets recreate everything using terraform, digital ocean, kubernetes and MAGIC! Sample rails app Build image First thing we'll do is to create a docker image that we'll use to build our rails app. Dockerfile.build: FROMruby:3.0.1WORKDIR/app# nodejs and yarn and clocRUN curl -sL https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -RUN echo "deb https://dl.</p></div><a href=../../../articles/2021/rails_on_kubernetes_with_tls/ class="btn btn-primary">Read more</a></div></div></div><footer class="footer bg-dark text-light mt-3"><div class=container><h2 class="py-5 font-weight-light my-0">Made in Brooklyn, NY.</h2></div></footer></body></html>