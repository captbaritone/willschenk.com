<!doctype html><html><head><title>Emacs Blog Writing and Navigation Mode</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet href=../../../css/theme.css><link rel=stylesheet href=../../../css/syntax.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-56296045-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script async defer data-domain=willschenk.com src=https://plausible.io/js/plausible.js></script><meta property="og:title" content="Emacs Blog Writing and Navigation Mode"><meta property="og:description" content="This blog is basically my labnotes where I explore different parts of technology. Almost all of my coding related activity starts off in this repo, while I explore different things to see how they work. I have a lot of things in drafts, and I wanted to learn how to build a simple emacs interface to let me navigate around my file system.  I couldn't find any good documentation on how to do anything with tabulated-list-mode so I spend the evening poking around and seeing how it works."><meta property="og:type" content="article"><meta property="og:url" content="https://willschenk.com/articles/2021/emacs_blogging_mode/"><meta property="article:published_time" content="2021-03-15T00:00:00+00:00"><meta property="article:modified_time" content="2021-03-15T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Emacs Blog Writing and Navigation Mode"><meta name=twitter:description content="This blog is basically my labnotes where I explore different parts of technology. Almost all of my coding related activity starts off in this repo, while I explore different things to see how they work. I have a lot of things in drafts, and I wanted to learn how to build a simple emacs interface to let me navigate around my file system.  I couldn't find any good documentation on how to do anything with tabulated-list-mode so I spend the evening poking around and seeing how it works."><meta name=twitter:site content="@wschenk"><style>.article p,.article ul,.article ol,.article table{max-width:45em}.article pre p{max-width:none;margin-top:-1.5rem}article.article p:first-child,.article blockquote{font-size:1.25em;font-weight:300;max-width:36em}.half-height-scroll{max-height:32em;overflow:scroll}</style></head><body><nav class="container my-5"><h1 class="pt-md-5 display-3"><a class=text-dark href=../../../>Will Schenk</a></h1><p><a class="text-dark h4 mr-3 font-weight-light" href=../../../articles/>Articles</a>
<a class="text-dark h4 mr-3 font-weight-light" href=../../../contact>Contact</a>
<a class="text-dark h4 mr-3 font-weight-light" href=../../../tags/>Tags</a>
<a href=../../../feed.xml class="mr-3 h4 text-light"><img src=../../../img/rss.svg alt=rss height=20 width=20></a>
<a href=https://twitter.com/@wschenk class="mr-3 h4 text-light"><img src=../../../img/twitter.svg alt=twitter height=20 width=20></a>
<a href=https://instagram.com/wschenk class="mr-3 h4 text-light"><img src=../../../img/instagram.svg alt=instagram height=20 width=20></a>
<a href=https://github.com/wschenk class="mr-3 h4 text-light"><img src=../../../img/github.svg alt=github height=20 width=20></a>
<a href=https://linkedin.com/in/will-schenk-420266 class="mr-3 h4 text-light"><img src=../../../img/linkedin.svg alt=linkedin height=20 width=20></a></p></nav><div class=container><h1 class=mt-5>Emacs Blog Writing and Navigation Mode</h1><h2 class="font-weight-light font-italic mb-3">emacs and hugo sitting in a tree</h2><p class="text-muted mt-3"><a class=text-muted href=https://willschenk.com/articles/2021/emacs_blogging_mode/>Published March 15, 2021</a>
<a class=text-muted href=../../../tags/emacs>#emacs,</a>
<a class=text-muted href=../../../tags/hugo>#hugo,</a>
<a class=text-muted href=../../../tags/elisp>#elisp,</a>
<a class=text-muted href=../../../tags/tabulated-list-mode>#tabulated-list-mode</a></p><article class="article mt-5"><p>This blog is basically my labnotes where I explore different parts of
technology. Almost all of my coding related activity starts off in
this repo, while I explore different things to see how they work. I
have a lot of things in drafts, and I wanted to learn how to build a
simple emacs interface to let me navigate around my file system.</p><p>I couldn't find any good documentation on how to do anything with
<code class=verbatim>tabulated-list-mode</code> so I spend the evening poking around and seeing
how it works. Here you go.</p><p>The final file is <a href=blog.el>blog.el</a></p><h2 id=headline-1>My basical directory structure</h2><p>I have my repo checked out at <code class=verbatim>~/willschenk.com</code>, and I put all my work
in <code class=verbatim>content/articles</code> and then the year. So this file is called
<code class=verbatim>/home/wschenk/willschenk.com/content/articles/2021/emacs_blogging_mode/index.org</code></p><p>Sometimes the <code class=verbatim>org</code> file is at the top level directory, and in the past
I wrote in <code class=verbatim>md</code> files so I want to make sure that they come through as
well.</p><div class="src src-elisp"><div class=highlight><pre class=chroma><code class=language-elisp data-lang=elisp>  <span class=c1>;; set the directory</span>
  <span class=p>(</span><span class=nb>setq</span> <span class=nv>blog-mode-base-dir</span> <span class=s>&#34;/home/wschenk/willschenk.com/content/articles&#34;</span><span class=p>)</span>
  <span class=p>(</span><span class=nb>require</span> <span class=ss>&#39;transient</span><span class=p>)</span></code></pre></div></div><h2 id=headline-2>How <code class=verbatim>tabulated-list-mode</code> works</h2><p>The basic idea is that</p><ol><li><p>You create a derived mode from <code class=verbatim>tabulated-list-mode</code></p></li><li><p>This defines the column headers in <code class=verbatim>tabulated-list-format</code>, and some
other stuff</p></li><li><p>You create a function that</p><ul><li><p>Creates a new buffer</p></li><li><p>Switches to your derived mode</p></li><li><p>Sets <code class=verbatim>tabluated-list-entries</code>, which is a list of lists, the first
element being the key and the following elements are the data</p></li><li><p>Calles <code class=verbatim>(tabulated-list-print t)</code> which displays the data</p></li></ul></li><li><p>You create a mode map that lets you add functions, the selected <code class=verbatim>key</code>
is returned by <code class=verbatim>tabulated-list-get-id</code>.</p></li></ol><p>One tricky thing to figure out is how to create the data. It looks like</p><div class="src src-elisp"><div class=highlight><pre class=chroma><code class=language-elisp data-lang=elisp>   <span class=p>(</span><span class=nf>list</span>
    <span class=p>(</span><span class=nf>list</span> <span class=nv>key1</span> <span class=p>[</span><span class=nv>col1</span> <span class=nv>col2</span> <span class=nv>col3</span><span class=p>])</span>
    <span class=p>(</span><span class=nf>list</span> <span class=nv>key2</span> <span class=p>[</span><span class=nv>col1</span> <span class=nv>col2</span> <span class=nv>col3</span><span class=p>]))</span></code></pre></div></div><p>Which you can create using <code class=verbatim>(list key1 (vector col1 col2 col3))</code> if you
want to actually use the values that <code class=verbatim>col1</code> points to rather than the
symbol <code class=verbatim>col1</code> itself. Yay lisp!</p><p>Let's get started.</p><h2 id=headline-3>Looking at the front matter</h2><p>This function takes a file, and passes it through <code class=verbatim>awk</code> to parse the
front matter. We will basically call this 4 times for each file to
pull out the <code class=verbatim>title</code>, <code class=verbatim>date</code>, <code class=verbatim>draft</code>, and <code class=verbatim>tags</code>.</p><div class="src src-elisp"><div class=highlight><pre class=chroma><code class=language-elisp data-lang=elisp>  <span class=p>(</span><span class=nb>defun</span> <span class=nv>blog-mode-file-peek</span> <span class=p>(</span><span class=nv>pattern</span> <span class=nv>file</span><span class=p>)</span>
    <span class=p>(</span><span class=nb>let</span> <span class=p>((</span><span class=nv>result</span> <span class=p>(</span><span class=nf>car</span> <span class=p>(</span><span class=nv>process-lines</span> <span class=s>&#34;awk&#34;</span> <span class=s>&#34;-F: &#34;</span> <span class=p>(</span><span class=nf>concat</span> <span class=nv>pattern</span> <span class=s>&#34; {print $2}&#34;</span><span class=p>)</span> <span class=nv>file</span><span class=p>))))</span>
      <span class=p>(</span><span class=nb>if</span> <span class=nv>result</span>
          <span class=p>(</span><span class=nv>replace-regexp-in-string</span> <span class=s>&#34;\&#34;&#34;</span> <span class=s>&#34;&#34;</span> <span class=nv>result</span><span class=p>)</span>
        <span class=s>&#34;&#34;</span><span class=p>)))</span></code></pre></div></div><p>Also, I'm removing any quotes around the results.</p><h2 id=headline-4>Parse a <code class=verbatim>.org</code> file</h2><p>This takes a file, and pulls out the attributes. I'm assuming that
the first ones it find is actually the top matter, we ignore all other
matches other than the first.</p><div class="src src-elisp"><div class=highlight><pre class=chroma><code class=language-elisp data-lang=elisp>  <span class=p>(</span><span class=nb>defun</span> <span class=nv>blog-mode-parse-org</span> <span class=p>(</span><span class=nv>file</span><span class=p>)</span>
    <span class=p>(</span><span class=nb>let</span> <span class=p>((</span><span class=nv>title</span> <span class=p>(</span><span class=nv>blog-mode-file-peek</span> <span class=s>&#34;/\\+title/&#34;</span> <span class=nv>file</span><span class=p>))</span>
          <span class=p>(</span><span class=nv>date</span> <span class=p>(</span><span class=nv>blog-mode-file-peek</span> <span class=s>&#34;/\\+date/&#34;</span> <span class=nv>file</span><span class=p>))</span>
          <span class=p>(</span><span class=nv>draft</span> <span class=p>(</span><span class=nv>blog-mode-file-peek</span> <span class=s>&#34;/\\+draft/&#34;</span> <span class=nv>file</span><span class=p>))</span>
          <span class=p>(</span><span class=nv>tags</span> <span class=p>(</span><span class=nv>blog-mode-file-peek</span> <span class=s>&#34;/\\+tags/&#34;</span> <span class=nv>file</span><span class=p>)))</span>
    
      <span class=p>(</span><span class=nf>list</span> <span class=nv>file</span> <span class=p>(</span><span class=nf>vector</span> <span class=nv>title</span> <span class=nv>draft</span> <span class=nv>date</span> <span class=nv>tags</span><span class=p>))))</span></code></pre></div></div><div class="src src-elisp"><div class=highlight><pre class=chroma><code class=language-elisp data-lang=elisp>  <span class=c1>;; parse an org-file test</span>
  <span class=p>(</span><span class=nb>setq</span> <span class=nv>org-test</span> <span class=s>&#34;/home/wschenk/willschenk.com/content/articles/2021/setting_up_emacs_for_typescript_development.org&#34;</span><span class=p>)</span>

  <span class=p>(</span><span class=nv>blog-mode-parse-org</span> <span class=nv>org-test</span><span class=p>)</span></code></pre></div></div><h2 id=headline-5>Parsing an <code class=verbatim>md</code> file</h2><p>Depending upon what sort of front matter you use, you may need to
adjust the regex. All my old markdown files are using <code class=verbatim>yaml</code> and not
<code class=verbatim>toml</code>, so your mileage may vary.</p><div class="src src-elisp"><div class=highlight><pre class=chroma><code class=language-elisp data-lang=elisp>
  <span class=p>(</span><span class=nb>defun</span> <span class=nv>blog-mode-parse-md</span> <span class=p>(</span><span class=nv>file</span><span class=p>)</span>
    <span class=p>(</span><span class=nb>let</span> <span class=p>((</span><span class=nv>title</span> <span class=p>(</span><span class=nv>blog-mode-file-peek</span> <span class=s>&#34;/^title/&#34;</span> <span class=nv>file</span><span class=p>))</span>
          <span class=p>(</span><span class=nv>date</span> <span class=p>(</span><span class=nv>blog-mode-file-peek</span> <span class=s>&#34;/^date/&#34;</span> <span class=nv>file</span><span class=p>))</span>
          <span class=p>(</span><span class=nv>draft</span> <span class=p>(</span><span class=nv>blog-mode-file-peek</span> <span class=s>&#34;/^draft/&#34;</span> <span class=nv>file</span><span class=p>))</span>
          <span class=p>(</span><span class=nv>tags</span> <span class=p>(</span><span class=nv>blog-mode-file-peek</span> <span class=s>&#34;/^tags/&#34;</span> <span class=nv>file</span><span class=p>)))</span>
      <span class=p>(</span><span class=nf>list</span> <span class=nv>file</span> <span class=p>(</span><span class=nf>vector</span> <span class=nv>title</span> <span class=nv>draft</span> <span class=nv>date</span> <span class=nv>tags</span><span class=p>))))</span></code></pre></div></div><div class="src src-elisp"><div class=highlight><pre class=chroma><code class=language-elisp data-lang=elisp>  <span class=c1>;; parse a md file test</span>
  <span class=p>(</span><span class=nb>setq</span> <span class=nv>md-test</span> <span class=s>&#34;/home/wschenk/willschenk.com/content/articles/2020/styling_tables_with_hugo.md&#34;</span><span class=p>)</span>

  <span class=p>(</span><span class=nv>blog-mode-parse-md</span> <span class=nv>md-test</span><span class=p>)</span></code></pre></div></div><h2 id=headline-6>Figure out if its a directory or not</h2><p>For short posts that don't have any tangling or other sub objects, my
<code class=verbatim>org</code> files live in the year directory. For others, it's either going
to be <code class=verbatim>index.md</code> or <code class=verbatim>index.org</code> so if we get a directory lets see which
one is in there.</p><div class="src src-elisp"><div class=highlight><pre class=chroma><code class=language-elisp data-lang=elisp>  <span class=p>(</span><span class=nb>defun</span> <span class=nv>blog-mode-parse-directory</span> <span class=p>(</span><span class=nv>directory</span><span class=p>)</span>
    <span class=p>(</span><span class=nb>let</span> <span class=p>((</span><span class=nv>md</span> <span class=p>(</span><span class=nf>concat</span> <span class=nv>directory</span> <span class=s>&#34;/index.md&#34;</span><span class=p>))</span>
          <span class=p>(</span><span class=nv>org</span> <span class=p>(</span><span class=nf>concat</span> <span class=nv>directory</span> <span class=s>&#34;/index.org&#34;</span><span class=p>)))</span>
      <span class=p>(</span><span class=nb>if</span> <span class=p>(</span><span class=nf>file-exists-p</span> <span class=nv>md</span><span class=p>)</span>
        <span class=p>(</span><span class=nv>blog-mode-parse-md</span> <span class=nv>md</span><span class=p>)</span>
        <span class=p>(</span><span class=nb>if</span> <span class=p>(</span><span class=nf>file-exists-p</span> <span class=nv>org</span><span class=p>)</span>
          <span class=p>(</span><span class=nv>blog-mode-parse-org</span> <span class=nv>org</span><span class=p>)</span>
          <span class=no>nil</span><span class=p>))))</span></code></pre></div></div><div class="src src-elisp"><div class=highlight><pre class=chroma><code class=language-elisp data-lang=elisp>  <span class=c1>;; What can we figure out from a directory test</span>
  <span class=p>(</span><span class=nb>setq</span> <span class=nv>dir-test</span> <span class=s>&#34;/home/wschenk/willschenk.com/content/articles/2021/gist_in_emacs&#34;</span><span class=p>)</span>

  <span class=p>(</span><span class=nv>blog-mode-parse-directory</span> <span class=nv>dir-test</span><span class=p>)</span></code></pre></div></div><h2 id=headline-7>Figure out which parser to delegate to</h2><p>Given a file name or a directory, figure out which parse method knows
how to make sense of it.</p><div class="src src-elisp"><div class=highlight><pre class=chroma><code class=language-elisp data-lang=elisp>  <span class=p>(</span><span class=nb>defun</span> <span class=nv>blog-mode-parse</span> <span class=p>(</span><span class=nv>file</span><span class=p>)</span>
    <span class=p>(</span><span class=nb>if</span> <span class=p>(</span><span class=nf>file-directory-p</span> <span class=nv>file</span><span class=p>)</span>
        <span class=p>(</span><span class=nv>blog-mode-parse-directory</span> <span class=nv>file</span><span class=p>)</span>
      <span class=p>(</span><span class=nb>let</span> <span class=p>((</span><span class=nv>ex</span> <span class=p>(</span><span class=nv>file-name-extension</span> <span class=nv>file</span><span class=p>)))</span>
        <span class=p>(</span><span class=nb>if</span> <span class=p>(</span><span class=nv>string=</span> <span class=nv>ex</span> <span class=s>&#34;md&#34;</span><span class=p>)</span>
            <span class=p>(</span><span class=nv>blog-mode-parse-md</span> <span class=nv>file</span><span class=p>)</span>
          <span class=p>(</span><span class=nb>if</span> <span class=p>(</span><span class=nv>string=</span> <span class=nv>ex</span> <span class=s>&#34;org&#34;</span><span class=p>)</span>
              <span class=p>(</span><span class=nv>blog-mode-parse-org</span> <span class=nv>file</span><span class=p>)</span>
            <span class=p>(</span><span class=nf>message</span> <span class=p>(</span><span class=nf>concat</span> <span class=s>&#34;Unknown extension &#34;</span> <span class=nv>ex</span><span class=p>)))))))</span></code></pre></div></div><div class="src src-elisp"><div class=highlight><pre class=chroma><code class=language-elisp data-lang=elisp>  <span class=c1>;; another test</span>
  <span class=p>(</span><span class=nv>blog-mode-parse</span> <span class=nv>org-test</span><span class=p>)</span></code></pre></div></div><h2 id=headline-8>Scan through all of the files and then parse them</h2><p>I'm again shelling out to the <code class=verbatim>find</code> command with <code class=verbatim>-maxdepth</code> of <code class=verbatim>2</code> to give
me a list of the files and/or directories that contain blog posts.
For each of the files, I'm parsing them to get the data in tab form
that the mode knows how to deal with.</p><p><code class=verbatim>dolist</code> was fun to figure out.</p><div class="src src-elisp"><div class=highlight><pre class=chroma><code class=language-elisp data-lang=elisp>  <span class=p>(</span><span class=nb>defun</span> <span class=nv>blog-mode-refresh-data</span> <span class=p>()</span>
    <span class=p>(</span><span class=nb>setq</span> <span class=nv>blog-mode-entries</span> <span class=no>nil</span><span class=p>)</span>
    <span class=p>(</span><span class=nb>dolist</span> <span class=p>(</span><span class=nv>file</span> <span class=p>(</span><span class=nv>process-lines</span> <span class=s>&#34;find&#34;</span> <span class=nv>blog-mode-base-dir</span>  <span class=s>&#34;-maxdepth&#34;</span> <span class=s>&#34;2&#34;</span> <span class=s>&#34;-print&#34;</span><span class=p>))</span>
      <span class=p>(</span><span class=nb>let</span> <span class=p>((</span><span class=nv>entry</span> <span class=p>(</span><span class=nv>blog-mode-parse</span> <span class=nv>file</span><span class=p>)))</span>
        <span class=p>(</span><span class=nb>if</span> <span class=nv>entry</span>
            <span class=p>(</span><span class=nb>push</span> <span class=p>(</span><span class=nv>blog-mode-parse</span> <span class=nv>file</span><span class=p>)</span> <span class=nv>blog-mode-entries</span><span class=p>)))))</span></code></pre></div></div><div class="src src-elisp"><div class=highlight><pre class=chroma><code class=language-elisp data-lang=elisp>  <span class=p>(</span><span class=nv>blog-mode-refresh-data</span><span class=p>)</span></code></pre></div></div><h2 id=headline-9>Set up the mode itself</h2><p>We create a derived mode called <code class=verbatim>blog-mode</code> from <code class=verbatim>tabulated-list-mode</code>.
In it we set the columns, padding, sort order (on date) and
explicitely tell it to use our mode map, <code class=verbatim>blog-mode-map</code> defined below.
It's unclear why it doesn't pick it up automatically, but I needed to
call it out specifically.</p><p>We also create a <code class=verbatim>blog-list</code> function which is our entry point. This
creates and opens a new buffer, switches it to <code class=verbatim>blog-mode</code>, loads in our
data, and then tells it to display. <code class=verbatim>tabulated-list-entries</code> is local
to the buffer, by the by, so you can have multiple modes using the
same variable.</p><div class="src src-elisp"><div class=highlight><pre class=chroma><code class=language-elisp data-lang=elisp>  <span class=p>(</span><span class=nb>define-derived-mode</span> <span class=nv>blog-mode</span> <span class=nv>tabulated-list-mode</span> <span class=s>&#34;blog-mode&#34;</span> <span class=s>&#34;Major mode Blog Mode, to edit hugo blogs&#34;</span>
    <span class=p>(</span><span class=nb>setq</span> <span class=nv>tabulated-list-format</span> <span class=p>[(</span><span class=s>&#34;Title&#34;</span> <span class=mi>60</span> <span class=no>t</span><span class=p>)</span>
                                 <span class=p>(</span><span class=s>&#34;Draft&#34;</span> <span class=mi>5</span> <span class=no>nil</span><span class=p>)</span>
                                 <span class=p>(</span><span class=s>&#34;Date&#34;</span>  <span class=mi>11</span> <span class=no>t</span><span class=p>)</span>
                                 <span class=p>(</span><span class=s>&#34;Tags&#34;</span> <span class=mi>0</span> <span class=no>nil</span><span class=p>)])</span>
    <span class=p>(</span><span class=nb>setq</span> <span class=nv>tabulated-list-padding</span> <span class=mi>2</span><span class=p>)</span>
    <span class=p>(</span><span class=nb>setq</span> <span class=nv>tabulated-list-sort-key</span> <span class=p>(</span><span class=nf>cons</span> <span class=s>&#34;Date&#34;</span> <span class=no>t</span><span class=p>))</span>
    <span class=p>(</span><span class=nf>use-local-map</span> <span class=nv>blog-mode-map</span><span class=p>)</span>
    <span class=p>(</span><span class=nv>tabulated-list-init-header</span><span class=p>))</span>

  <span class=p>(</span><span class=nb>defun</span> <span class=nv>blog-list</span> <span class=p>()</span>
    <span class=p>(</span><span class=nb>interactive</span><span class=p>)</span>
    <span class=p>(</span><span class=nv>pop-to-buffer</span> <span class=s>&#34;*Blog Mode*&#34;</span> <span class=no>nil</span><span class=p>)</span>
    <span class=p>(</span><span class=nv>blog-mode</span><span class=p>)</span>
    <span class=p>(</span><span class=nv>blog-mode-refresh-data</span><span class=p>)</span>
    <span class=p>(</span><span class=nb>setq</span> <span class=nv>tabulated-list-entries</span> <span class=p>(</span><span class=nv>-non-nil</span> <span class=nv>blog-mode-entries</span><span class=p>))</span>
    <span class=p>(</span><span class=nv>tabulated-list-print</span> <span class=no>t</span><span class=p>))</span></code></pre></div></div><h2 id=headline-10>Create the mode map</h2><p>Here I'm defining some functions that are specific to our mode.</p><table class="table table-striped"><tbody><tr><td><code class=verbatim>?</code></td><td>Help</td></tr><tr><td><code class=verbatim>o</code></td><td>Open the selected file</td></tr><tr><td><code class=verbatim>r</code></td><td>Refresh lists</td></tr><tr><td><code class=verbatim>d</code></td><td>Only show drafts</td></tr><tr><td><code class=verbatim>p</code></td><td>Only show published posts</td></tr><tr><td><code class=verbatim>a</code></td><td>Show all posts</td></tr><tr><td><code class=verbatim>c</code></td><td>Create a new post</td></tr><tr><td><code class=verbatim>s</code></td><td>Start the hugo process</td></tr></tbody></table><p>For fun I also created a <code class=verbatim>transient</code> popup which shows all of this.</p><div class="src src-elisp"><div class=highlight><pre class=chroma><code class=language-elisp data-lang=elisp>  <span class=p>(</span><span class=nb>defvar</span> <span class=nv>blog-mode-map</span> <span class=no>nil</span> <span class=s>&#34;keymap for blog-mode&#34;</span><span class=p>)</span>

  <span class=p>(</span><span class=nb>setq</span> <span class=nv>blog-mode-map</span> <span class=p>(</span><span class=nf>make-sparse-keymap</span><span class=p>))</span>

  <span class=p>(</span><span class=nf>define-key</span> <span class=nv>blog-mode-map</span> <span class=p>(</span><span class=nv>kbd</span> <span class=s>&#34;?&#34;</span><span class=p>)</span> <span class=ss>&#39;blog-mode-help</span><span class=p>)</span>
  <span class=p>(</span><span class=nf>define-key</span> <span class=nv>blog-mode-map</span> <span class=p>(</span><span class=nv>kbd</span> <span class=s>&#34;o&#34;</span><span class=p>)</span> <span class=ss>&#39;blog-mode-open</span><span class=p>)</span>
  <span class=p>(</span><span class=nf>define-key</span> <span class=nv>blog-mode-map</span> <span class=p>(</span><span class=nv>kbd</span> <span class=s>&#34;&lt;return&gt;&#34;</span><span class=p>)</span> <span class=ss>&#39;blog-mode-open</span><span class=p>)</span>
  <span class=p>(</span><span class=nf>define-key</span> <span class=nv>blog-mode-map</span> <span class=p>(</span><span class=nv>kbd</span> <span class=s>&#34;d&#34;</span><span class=p>)</span> <span class=ss>&#39;blog-mode-drafts</span><span class=p>)</span>
  <span class=p>(</span><span class=nf>define-key</span> <span class=nv>blog-mode-map</span> <span class=p>(</span><span class=nv>kbd</span> <span class=s>&#34;a&#34;</span><span class=p>)</span> <span class=ss>&#39;blog-mode-all</span><span class=p>)</span>
  <span class=p>(</span><span class=nf>define-key</span> <span class=nv>blog-mode-map</span> <span class=p>(</span><span class=nv>kbd</span> <span class=s>&#34;p&#34;</span><span class=p>)</span> <span class=ss>&#39;blog-mode-published</span><span class=p>)</span>
  <span class=p>(</span><span class=nf>define-key</span> <span class=nv>blog-mode-map</span> <span class=p>(</span><span class=nv>kbd</span> <span class=s>&#34;r&#34;</span><span class=p>)</span> <span class=ss>&#39;blog-mode-refresh-all</span><span class=p>)</span>
  <span class=p>(</span><span class=nf>define-key</span> <span class=nv>blog-mode-map</span> <span class=p>(</span><span class=nv>kbd</span> <span class=s>&#34;c&#34;</span><span class=p>)</span> <span class=ss>&#39;blog-mode-make-draft</span><span class=p>)</span>
  <span class=p>(</span><span class=nf>define-key</span> <span class=nv>blog-mode-map</span> <span class=p>(</span><span class=nv>kbd</span> <span class=s>&#34;s&#34;</span><span class=p>)</span> <span class=ss>&#39;blog-mode-start-hugo</span><span class=p>)</span>
  <span class=p>(</span><span class=nf>define-key</span> <span class=nv>blog-mode-map</span> <span class=p>(</span><span class=nv>kbd</span> <span class=s>&#34;RET&#34;</span><span class=p>)</span> <span class=ss>&#39;blog-mode-open</span><span class=p>)</span>

  <span class=p>(</span><span class=nv>transient-define-prefix</span> <span class=nv>blog-mode-help</span> <span class=p>()</span>
    <span class=s>&#34;Help transient for blog mode.&#34;</span>
    <span class=p>[</span><span class=s>&#34;Blog mode help&#34;</span>
     <span class=p>(</span><span class=s>&#34;o&#34;</span> <span class=s>&#34;Open&#34;</span> <span class=nv>blog-mode-open</span><span class=p>)</span>
     <span class=p>(</span><span class=s>&#34;d&#34;</span> <span class=s>&#34;Drafts&#34;</span> <span class=nv>blog-mode-drafts</span><span class=p>)</span>
     <span class=p>(</span><span class=s>&#34;a&#34;</span> <span class=s>&#34;All&#34;</span> <span class=nv>blog-mode-all</span><span class=p>)</span>
     <span class=p>(</span><span class=s>&#34;p&#34;</span> <span class=s>&#34;Published&#34;</span> <span class=nv>blog-mode-published</span><span class=p>)</span>
     <span class=p>(</span><span class=s>&#34;r&#34;</span> <span class=s>&#34;Refresh&#34;</span> <span class=nv>blog-mode-refresh-all</span><span class=p>)</span>
     <span class=p>(</span><span class=s>&#34;c&#34;</span> <span class=s>&#34;Create post&#34;</span> <span class=nv>blog-mode-make-draft</span><span class=p>)</span>
     <span class=p>(</span><span class=s>&#34;s&#34;</span> <span class=s>&#34;Start hugo&#34;</span> <span class=nv>blog-mode-start-hugo</span><span class=p>)</span>
     <span class=p>])</span></code></pre></div></div><h2 id=headline-11>Actions: open</h2><p>I set the key to be the filename, so <code class=verbatim>(find-file
(tabulated-list-get-id))</code> opens the file.</p><div class="src src-elisp"><div class=highlight><pre class=chroma><code class=language-elisp data-lang=elisp>  <span class=p>(</span><span class=nb>defun</span> <span class=nv>blog-mode-open</span> <span class=p>()</span>
    <span class=p>(</span><span class=nb>interactive</span><span class=p>)</span>
    <span class=p>(</span><span class=nv>find-file</span> <span class=p>(</span><span class=nv>tabulated-list-get-id</span><span class=p>)))</span></code></pre></div></div><h2 id=headline-12>Actions: All/Published/Drafts</h2><p>These functions filter the <code class=verbatim>blog-mode-entries</code> variable to filter what
is displayed. I'm not sure how I feel about calling
<code class=verbatim>tabulated-list-print</code> each time but it seems to work.</p><div class="src src-elisp"><div class=highlight><pre class=chroma><code class=language-elisp data-lang=elisp>  <span class=p>(</span><span class=nb>defun</span> <span class=nv>blog-mode-refresh-all</span> <span class=p>()</span>
    <span class=p>(</span><span class=nb>interactive</span><span class=p>)</span>
    <span class=p>(</span><span class=nb>progn</span>
      <span class=p>(</span><span class=nv>blog-mode-refresh-data</span><span class=p>)</span>
      <span class=p>(</span><span class=nb>setq</span> <span class=nv>tabulated-list-entries</span> <span class=p>(</span><span class=nv>-non-nil</span> <span class=nv>blog-mode-entries</span><span class=p>))</span>
      <span class=p>(</span><span class=nv>tabulated-list-print</span> <span class=no>t</span><span class=p>)))</span>

  <span class=p>(</span><span class=nb>defun</span> <span class=nv>blog-mode-all</span> <span class=p>()</span> 
    <span class=p>(</span><span class=nb>interactive</span><span class=p>)</span>
    <span class=p>(</span><span class=nb>progn</span>
      <span class=p>(</span><span class=nb>setq</span> <span class=nv>tabulated-list-entries</span> <span class=p>(</span><span class=nv>-non-nil</span> <span class=nv>blog-mode-entries</span><span class=p>))</span>
      <span class=p>(</span><span class=nv>tabulated-list-print</span> <span class=no>t</span><span class=p>)))</span>

  <span class=p>(</span><span class=nb>defun</span> <span class=nv>blog-mode-drafts</span> <span class=p>()</span> 
    <span class=p>(</span><span class=nb>interactive</span><span class=p>)</span>
    <span class=p>(</span><span class=nb>progn</span>
      <span class=p>(</span><span class=nb>setq</span> <span class=nv>tabulated-list-entries</span> 
            <span class=p>(</span><span class=nv>-filter</span> <span class=p>(</span><span class=nb>lambda</span> <span class=p>(</span><span class=nv>x</span><span class=p>)</span>
                       <span class=p>(</span><span class=nv>string=</span> <span class=s>&#34;true&#34;</span>
                                <span class=p>(</span><span class=nf>aref</span> <span class=p>(</span><span class=nf>car</span> <span class=p>(</span><span class=nf>cdr</span> <span class=nv>x</span><span class=p>))</span> <span class=mi>1</span><span class=p>)))</span> <span class=p>(</span><span class=nv>-non-nil</span> <span class=nv>blog-mode-entries</span><span class=p>)))</span>
      <span class=p>(</span><span class=nv>tabulated-list-print</span> <span class=no>t</span><span class=p>)))</span>

  <span class=p>(</span><span class=nb>defun</span> <span class=nv>blog-mode-published</span> <span class=p>()</span> 
    <span class=p>(</span><span class=nb>interactive</span><span class=p>)</span>
    <span class=p>(</span><span class=nb>progn</span>
      <span class=p>(</span><span class=nb>setq</span> <span class=nv>tabulated-list-entries</span> 
            <span class=p>(</span><span class=nv>-filter</span> <span class=p>(</span><span class=nb>lambda</span> <span class=p>(</span><span class=nv>x</span><span class=p>)</span>
                       <span class=p>(</span><span class=nv>string=</span> <span class=s>&#34;&#34;</span>
                                <span class=p>(</span><span class=nf>aref</span> <span class=p>(</span><span class=nf>car</span> <span class=p>(</span><span class=nf>cdr</span> <span class=nv>x</span><span class=p>))</span> <span class=mi>1</span><span class=p>)))</span> <span class=nv>blog-mode-entries</span><span class=p>)))</span>
      <span class=p>(</span><span class=nv>tabulated-list-print</span> <span class=no>t</span><span class=p>))</span></code></pre></div></div><h2 id=headline-13>Actions: create a new post</h2><p>I like my urls to be the same as the title, so the first function here
normalizes the title to fit in the filesystem. I've forgotten where I
copied this code from, by thank you internet.</p><p>I have two types of posts. "mini" which just means its a standalone
file, and a full post, which is in a directory. I also turn on
automatic <code class=verbatim>org-babel-tangle</code> on save, which I set as a local org
variable.</p><div class="src src-elisp"><div class=highlight><pre class=chroma><code class=language-elisp data-lang=elisp>  <span class=p>(</span><span class=nb>defun</span> <span class=nv>string-title-to-filename</span> <span class=p>(</span><span class=nv>str</span><span class=p>)</span>
    <span class=s>&#34;FooBar =&gt; foo_bar&#34;</span>
    <span class=p>(</span><span class=nb>let</span> <span class=p>((</span><span class=nv>case-fold-search</span> <span class=no>nil</span><span class=p>))</span>
      <span class=p>(</span><span class=nb>setq</span> <span class=nv>str</span> <span class=p>(</span><span class=nv>replace-regexp-in-string</span> <span class=s>&#34;\\([a-z0-9]\\)\\([A-Z]\\)&#34;</span> <span class=s>&#34;\\1_\\2&#34;</span> <span class=nv>str</span><span class=p>))</span>
      <span class=p>(</span><span class=nb>setq</span> <span class=nv>str</span> <span class=p>(</span><span class=nv>replace-regexp-in-string</span> <span class=s>&#34;\\([A-Z]+\\)\\([A-Z][a-z]\\)&#34;</span> <span class=s>&#34;\\1_\\2&#34;</span> <span class=nv>str</span><span class=p>))</span>
      <span class=p>(</span><span class=nb>setq</span> <span class=nv>str</span> <span class=p>(</span><span class=nv>replace-regexp-in-string</span> <span class=s>&#34;-&#34;</span> <span class=s>&#34;_&#34;</span> <span class=nv>str</span><span class=p>))</span> <span class=c1>; FOO-BAR =&gt; FOO_BAR</span>
      <span class=p>(</span><span class=nb>setq</span> <span class=nv>str</span> <span class=p>(</span><span class=nv>replace-regexp-in-string</span> <span class=s>&#34;_+&#34;</span> <span class=s>&#34;_&#34;</span> <span class=nv>str</span><span class=p>))</span>
      <span class=p>(</span><span class=nb>setq</span> <span class=nv>str</span> <span class=p>(</span><span class=nv>replace-regexp-in-string</span> <span class=s>&#34; &#34;</span> <span class=s>&#34;_&#34;</span> <span class=nv>str</span><span class=p>))</span>
      <span class=p>(</span><span class=nf>downcase</span> <span class=nv>str</span><span class=p>)))</span>

  <span class=p>(</span><span class=nb>defun</span> <span class=nv>blog-mode-make-draft</span> <span class=p>()</span>
    <span class=s>&#34;Little function to create a org file inside of the blog&#34;</span>
    <span class=p>(</span><span class=nb>interactive</span><span class=p>)</span>
    <span class=p>(</span><span class=nb>let*</span> <span class=p>(</span>
           <span class=p>(</span><span class=nv>mini</span> <span class=p>(</span><span class=nf>yes-or-no-p</span> <span class=s>&#34;Mini post? &#34;</span><span class=p>))</span>
           <span class=p>(</span><span class=nv>title</span> <span class=p>(</span><span class=nf>read-from-minibuffer</span> <span class=s>&#34;Title: &#34;</span><span class=p>))</span>
           <span class=p>(</span><span class=nv>year</span> <span class=p>(</span><span class=nf>format-time-string</span> <span class=s>&#34;%Y&#34;</span><span class=p>))</span>
           <span class=p>(</span><span class=nv>filename</span> <span class=p>(</span><span class=nv>string-title-to-filename</span> <span class=nv>title</span><span class=p>))</span>
           <span class=p>(</span><span class=nv>rootpath</span> <span class=p>(</span><span class=nf>concat</span> <span class=nv>blog-mode-base-dir</span> <span class=s>&#34;/&#34;</span> <span class=nv>year</span> <span class=s>&#34;/&#34;</span> <span class=nv>filename</span><span class=p>))</span>
           <span class=p>(</span><span class=nv>path</span> <span class=p>(</span><span class=nb>if</span> <span class=nv>mini</span> <span class=p>(</span><span class=nf>concat</span> <span class=nv>rootpath</span> <span class=s>&#34;.org&#34;</span><span class=p>)</span> <span class=p>(</span><span class=nf>concat</span> <span class=nv>rootpath</span> <span class=s>&#34;/index.org&#34;</span><span class=p>)))</span>
           <span class=p>)</span>
      <span class=p>(</span><span class=nf>set-buffer</span> <span class=p>(</span><span class=nv>find-file</span> <span class=nv>path</span><span class=p>))</span>
      <span class=p>(</span><span class=nf>insert</span> <span class=s>&#34;#+title: &#34;</span> <span class=nv>title</span> <span class=s>&#34;\n&#34;</span><span class=p>)</span>
      <span class=p>(</span><span class=nf>insert</span> <span class=s>&#34;#+date: &#34;</span> <span class=p>(</span><span class=nf>format-time-string</span> <span class=s>&#34;%Y-%m-%d&#34;</span><span class=p>)</span> <span class=s>&#34;\n&#34;</span><span class=p>)</span>
      <span class=p>(</span><span class=nf>insert</span> <span class=s>&#34;#+draft: true\n&#34;</span><span class=p>)</span>
      <span class=p>(</span><span class=nb>unless</span> <span class=nv>mini</span>
        <span class=p>(</span><span class=nf>insert</span> <span class=s>&#34;\n* References\n# Local Variables:\n# eval: (add-hook &#39;after-save-hook (lambda ()(org-babel-tangle)) nil t)\n# End:\n&#34;</span><span class=p>))</span>
      <span class=p>)</span>
    <span class=p>)</span></code></pre></div></div><h2 id=headline-14>Action: Start hugo</h2><p>This is probably too particular for my machine, since I run hugo
inside of a docker container so I need to start it with a script, but
this function starts hugo if it isn't running, then waits 5 seconds to
call <code class=verbatim>xdg-open</code> to bring it up in the browser.</p><div class="src src-elisp"><div class=highlight><pre class=chroma><code class=language-elisp data-lang=elisp>  <span class=p>(</span><span class=nb>defun</span> <span class=nv>blog-mode-start-hugo</span> <span class=p>()</span>
    <span class=s>&#34;Starts up a hugo watch process&#34;</span>
    <span class=p>(</span><span class=nb>interactive</span><span class=p>)</span>
    <span class=p>(</span><span class=nb>let*</span> <span class=p>(</span>
           <span class=p>(</span><span class=nv>default-directory</span> <span class=s>&#34;/home/wschenk/willschenk.com&#34;</span><span class=p>)</span>
           <span class=p>(</span><span class=nv>height</span> <span class=p>(</span><span class=nf>/</span> <span class=p>(</span><span class=nf>frame-total-lines</span><span class=p>)</span> <span class=mi>3</span><span class=p>))</span>
           <span class=p>(</span><span class=nv>name</span> <span class=s>&#34;*shell hugo process&#34;</span><span class=p>))</span>
      <span class=p>(</span><span class=nv>delete-other-windows</span><span class=p>)</span>
      <span class=p>(</span><span class=nv>split-window-vertically</span> <span class=p>(</span><span class=nf>-</span> <span class=nv>height</span><span class=p>))</span>
      <span class=p>(</span><span class=nv>other-window</span> <span class=mi>1</span><span class=p>)</span>
      <span class=p>(</span><span class=nv>switch-to-buffer</span> <span class=nv>name</span><span class=p>)</span>
      <span class=p>(</span><span class=nb>unless</span> <span class=p>(</span><span class=nf>get-buffer-process</span> <span class=nv>name</span><span class=p>)</span>
        <span class=p>(</span><span class=nv>async-shell-command</span> <span class=s>&#34;cd /home/wschenk/willschenk.com;./dev.sh&#34;</span> <span class=nv>name</span><span class=p>))</span>
      <span class=p>(</span><span class=nv>async-shell-command</span> <span class=s>&#34;sleep 5;xdg-open http://localhost:1313&#34;</span> <span class=p>(</span><span class=nf>get-buffer</span> <span class=s>&#34;*hugo web opener*&#34;</span><span class=p>))))</span></code></pre></div></div><h2 id=headline-15>Plug it in</h2><div class="src src-elisp"><div class=highlight><pre class=chroma><code class=language-elisp data-lang=elisp><span class=p>(</span><span class=nv>global-set-key</span> <span class=p>(</span><span class=nv>kbd</span> <span class=s>&#34;C-c d&#34;</span><span class=p>)</span> <span class=ss>&#39;blog-list</span><span class=p>)</span></code></pre></div></div><h2 id=headline-16>Conclusion</h2><p>I couldn't find any good tutorials on how to write an emacs mode to
interact with my system, so I thought I should write one. I think
there's probably something on YouTube but it didn't show up in any
search algorithms so hopefully this is helpful.</p><h2 id=headline-17>References</h2><ol><li><p><a href=https://pagefault.se/post/lets-build-docker-mode-part-1/>https://pagefault.se/post/lets-build-docker-mode-part-1/</a></p></li><li><p><a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/File-Name-Components.html#File-Name-Components>https://www.gnu.org/software/emacs/manual/html_node/elisp/File-Name-Components.html#File-Name-Components</a></p></li><li><p><a href=http://lgmoneda.github.io/2017/03/15/elisp-summary.html#loops>http://lgmoneda.github.io/2017/03/15/elisp-summary.html#loops</a></p></li><li><p><a href=http://ergoemacs.org/emacs/elisp_vector.html>http://ergoemacs.org/emacs/elisp_vector.html</a></p></li><li><p><a href=https://stackoverflow.com/questions/2234860/lisp-filter-out-results-from-list-not-matching-predicate>https://stackoverflow.com/questions/2234860/lisp-filter-out-results-from-list-not-matching-predicate</a></p></li><li><p><a href=https://vallyscode.github.io/posts/tabulated-list-mode/>https://vallyscode.github.io/posts/tabulated-list-mode/</a></p></li></ol></article></div><div class="bg-light py-5"><div class=container><h2 class=text-center>Read next</h2><div class=row><div class="col-md-6 text-center"></div><div class="col-md-6 text-center">Previous Post:
<a href=../../../articles/2021/asdf_as_environment_manager/>asdf as environment manager</a></div></div></div></div><div class="container mt-5"><h2 class=text-center>See also</h2><div class=row><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2021/installing_emacs_on_buster/>Installing emacs on buster</a></p><p class="lead font-italic mb-0">so many ways to get software</p><div class="font-weight-light mt-3"><p>I've already written about installing emacs-snapshot on debian buster, here are two additional ways. The first is to use flatpak, and the other is to build from source. Flatpack sudo apt-get install flatpak sudo apt install gnome-software-plugin-flatpak sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo Then: sudo flatpak install flathub org.gnu.emacs And running it: flatpak run org.gnu.emacs You can then pin it in your dock and you are good to go.</p></div><a href=../../../articles/2021/installing_emacs_on_buster/ class="btn btn-primary">Read more</a></div><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2020/getting_websters/>Getting Websters</a></p><p class="lead font-italic mb-0">More glorious language</p><div class="font-weight-light mt-3"><p>A few years ago I read a great post about the value of a good dictionary, which I installed on my laptop and then promptly forgot about. The post is very moving, and I recommend checking it out. It was recently mentioned on the planet emacs blog circuit and so I thought I'd document how to get it up and running on my laptop. Also I don't understand what the appeal of John McPhee's writing, I've tried a few of his books but found them all so plodding.</p></div><a href=../../../articles/2020/getting_websters/ class="btn btn-primary">Read more</a></div><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2020/upgrading_emacs_on_debian/>Upgrading emacs on debian</a></p><p class="lead font-italic mb-0">fixing crashes</p><div class="font-weight-light mt-3"><p>Been playing with elfeed on Emacs 26.1 on buster and it keeps crashing. I think for font related reasons. So lets follow the Emacs Wiki Instructions to upgrade to emacs-snapshots and see if that helps. Add the snap shot repository. Make sure you have the tools installed so that apt can do it's internet thing. sudo apt-get install software-properties-common sudo apt-get update Add the signing key: wget -q http://emacs.</p></div><a href=../../../articles/2020/upgrading_emacs_on_debian/ class="btn btn-primary">Read more</a></div></div></div><footer class="footer bg-dark text-light mt-3"><div class=container><h2 class="py-5 font-weight-light my-0">Made in Brooklyn, NY.</h2></div></footer></body></html>