<!doctype html><html><head><title>CLOCViz</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet href=../../../css/theme.css><link rel=stylesheet href=../../../css/syntax.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-56296045-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script async defer data-domain=willschenk.com src=https://plausible.io/js/plausible.js></script><meta property="og:title" content="CLOCViz"><meta property="og:description" content="I've been looking at small tools that we could combine together to get a better sense of a repository. clocviz is a nifty on that puts a front end on top of cloc, so I packaged up a docker container that lets you pass in a url and will generate some static html for you. First we package up clocviz   We'll build this using go 1.16.2 and then install a few dependancies, specifically cloc, wget, and git."><meta property="og:type" content="article"><meta property="og:url" content="https://willschenk.com/articles/2021/cloc_viz/"><meta property="article:published_time" content="2021-03-31T00:00:00+00:00"><meta property="article:modified_time" content="2021-03-31T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="CLOCViz"><meta name=twitter:description content="I've been looking at small tools that we could combine together to get a better sense of a repository. clocviz is a nifty on that puts a front end on top of cloc, so I packaged up a docker container that lets you pass in a url and will generate some static html for you. First we package up clocviz   We'll build this using go 1.16.2 and then install a few dependancies, specifically cloc, wget, and git."><meta name=twitter:site content="@wschenk"><style>.article p,.article ul,.article ol,.article table{max-width:45em}.article pre p{max-width:none;margin-top:-1.5rem}article.article p:first-child,.article blockquote{font-size:1.25em;font-weight:300;max-width:36em}.half-height-scroll{max-height:32em;overflow:scroll}</style></head><body><nav class="container my-5"><h1 class="pt-md-5 display-3"><a class=text-dark href=../../../>Will Schenk</a></h1><p><a class="text-dark h4 mr-3 font-weight-light" href=../../../articles/>Articles</a>
<a class="text-dark h4 mr-3 font-weight-light" href=../../../contact>Contact</a>
<a class="text-dark h4 mr-3 font-weight-light" href=../../../tags/>Tags</a>
<a href=../../../feed.xml class="mr-3 h4 text-light"><img src=../../../img/rss.svg alt=rss height=20 width=20></a>
<a href=https://twitter.com/@wschenk class="mr-3 h4 text-light"><img src=../../../img/twitter.svg alt=twitter height=20 width=20></a>
<a href=https://instagram.com/wschenk class="mr-3 h4 text-light"><img src=../../../img/instagram.svg alt=instagram height=20 width=20></a>
<a href=https://github.com/wschenk class="mr-3 h4 text-light"><img src=../../../img/github.svg alt=github height=20 width=20></a>
<a href=https://linkedin.com/in/will-schenk-420266 class="mr-3 h4 text-light"><img src=../../../img/linkedin.svg alt=linkedin height=20 width=20></a></p></nav><div class=container><h1 class=mt-5>CLOCViz</h1><h2 class="font-weight-light font-italic mb-3">Run some vizualizations on a repo</h2><p class="text-muted mt-3"><a class=text-muted href=https://willschenk.com/articles/2021/cloc_viz/>Published March 31, 2021</a>
<a class=text-muted href=../../../tags/git>#git,</a>
<a class=text-muted href=../../../tags/cloc>#cloc,</a>
<a class=text-muted href=../../../tags/clocviz>#clocviz</a></p><article class="article mt-5"><p>I've been looking at small tools that we could combine together to get
a better sense of a repository. <a href=https://github.com/cdkini/clocviz>clocviz</a> is a nifty on that puts a
front end on top of <a href=https://github.com/AlDanial/cloc>cloc</a>, so I packaged up a docker container that
lets you pass in a url and will generate some static html for you.</p><h2 id=headline-1>First we package up <code class=verbatim>clocviz</code></h2><p>We'll build this using <code class=verbatim>go 1.16.2</code> and then install a few dependancies,
specifically <code class=verbatim>cloc</code>, <code class=verbatim>wget</code>, and <code class=verbatim>git</code>.</p><div class="src src-dockerfile"><div class=highlight><pre class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=k>FROM</span><span class=s> golang:1.16.2-buster</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> apt-get install -y cloc wget git<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span><span class=err></span><span class=k>RUN</span> git clone https://github.com/cdkini/clocviz clocviz<span class=err>
</span><span class=err></span><span class=k>RUN</span> <span class=nb>cd</span> clocviz <span class=o>&amp;&amp;</span> go get <span class=o>&amp;&amp;</span> go build<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>COPY</span> *sh ./<span class=err>
</span><span class=err></span><span class=k>RUN</span> chmod +x *sh<span class=err>
</span><span class=err></span><span class=k>RUN</span> chmod <span class=m>777</span> /app<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>ENTRYPOINT</span> /app/entry_point.sh</code></pre></div></div><h2 id=headline-2>Script to pull down the repo and generate the html</h2><p>This script expects the <code class=verbatim>REPO</code> environment variable to be set to a URI
that <code class=verbatim>git</code> can clone. It will pull down the repo, then run clocviz, and
then scrape the html into the <code class=verbatim>/output</code> directory (presumably mounted as
a volume.)</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>  <span class=c1>#/bin/bash</span>
  <span class=nv>REPO_WORK_DIR</span><span class=o>=</span>/app/repository
  <span class=nv>WORK_DIR</span><span class=o>=</span>/output

  <span class=k>if</span> <span class=o>[</span> -d <span class=si>${</span><span class=nv>REPO_WORK_DIR</span><span class=si>}</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
     <span class=nb>echo</span> Using repo in <span class=si>${</span><span class=nv>REPO_WORK_DIR</span><span class=si>}</span>
  <span class=k>else</span>
      <span class=k>if</span> <span class=o>[</span> -z <span class=s2>&#34;</span><span class=nv>$REPO</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
          <span class=nb>echo</span> Please <span class=nb>set</span> the REPO env variable or mount <span class=si>${</span><span class=nv>REPO_WORK_DIR</span><span class=si>}</span>
          <span class=nb>exit</span> <span class=m>1</span>
      <span class=k>fi</span>

      git clone <span class=nv>$REPO</span> <span class=si>${</span><span class=nv>REPO_WORK_DIR</span><span class=si>}</span>
  <span class=k>fi</span>

  <span class=k>if</span> <span class=o>[</span> ! -d <span class=si>${</span><span class=nv>WORK_DIR</span><span class=si>}</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
      <span class=nb>echo</span> Creating <span class=si>${</span><span class=nv>WORK_DIR</span><span class=si>}</span>
      mkdir -p <span class=si>${</span><span class=nv>WORK_DIR</span><span class=si>}</span>
  <span class=k>fi</span>

  <span class=c1># clocviz serves static files from its filesystem, so we need to run it from there</span>
  <span class=o>(</span><span class=nb>cd</span> /app/clocviz<span class=p>;</span> clocviz <span class=nv>$REPO_WORK_DIR</span> <span class=p>&amp;</span><span class=o>)</span>

  <span class=nb>cd</span> <span class=k>$(</span>mktemp -d<span class=k>)</span>
  wget --recursive <span class=se>\
</span><span class=se></span>       --page-requisites <span class=se>\
</span><span class=se></span>       --convert-links <span class=se>\
</span><span class=se></span>       --no-parent <span class=se>\
</span><span class=se></span>       http://localhost:8080

   cp -r localhost:8080/* <span class=nv>$WORK_DIR</span></code></pre></div></div><h2 id=headline-3>Build the container</h2><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>docker build . -t wschenk/clocviz</code></pre></div></div><h2 id=headline-4>Do a run</h2><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>  <span class=nb>export</span> <span class=nv>REPO</span><span class=o>=</span>https://github.com/ruby-git/ruby-git
  mkdir -p output

  docker run --rm -it <span class=se>\
</span><span class=se></span>         -v <span class=nv>$PWD</span>/output:/output <span class=se>\
</span><span class=se></span>         --env REPO <span class=se>\
</span><span class=se></span>         -u <span class=k>$(</span>id -u<span class=k>)</span> <span class=se>\
</span><span class=se></span>         wschenk/clocviz</code></pre></div></div><p>Then test:</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=o>(</span><span class=nb>cd</span> output<span class=p>;</span>npx live-server<span class=o>)</span></code></pre></div></div><h2 id=headline-5>Thoughts</h2><p>The output HTML needs a bit of work on smaller screens but that's
pretty neat.</p><h2 id=headline-6>References</h2><ol><li><p><a href=https://github.com/cdkini/clocviz>https://github.com/cdkini/clocviz</a></p></li></ol></article></div><div class="bg-light py-5"><div class=container><h2 class=text-center>Read next</h2><div class=row><div class="col-md-6 text-center"></div><div class="col-md-6 text-center">Previous Post:
<a href=../../../articles/2021/emacs_blogging_mode/>Emacs Blog Writing and Navigation Mode</a></div></div></div></div><div class="container mt-5"><h2 class=text-center>See also</h2><div class=row><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2020/gitlog_in_sqlite/>gitlog in sqlite</a></p><p class="lead font-italic mb-0">sql is great</p><div class="font-weight-light mt-3"><p>askgit is a great way to look at information inside of a repository. However it currently doesn't support looking at the files inside of the commit itself – it gives you a view of the repository at the time of the commit, but not the patch itself. Since I don't know enough about golang and sqlite virtual tables, let's just create a sqlite3 database from the logfile. Get the gitlog We are going to use our favorite test repo, ruby-git because it's so deliciously meta.</p></div><a href=../../../articles/2020/gitlog_in_sqlite/ class="btn btn-primary">Read more</a></div><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2020/using_askgit/>Using Askgit</a></p><p class="lead font-italic mb-0">SQL is so nice</p><div class="font-weight-light mt-3"><p>askgit provides a sql interface to your git repository. Let's install it and see what we can figure out about the repo. Installing Following the instructions on the website, we can build the go binary with: go get -v -tags=sqlite_vtable github.com/augmentable-dev/askgit This will download the package, the dependencies, and compile everything into an executable. If you can't figure out where it's installed, check that you have GOPATH set correctly, and it will end up in $GOPATH/bin.</p></div><a href=../../../articles/2020/using_askgit/ class="btn btn-primary">Read more</a></div></div></div><footer class="footer bg-dark text-light mt-3"><div class=container><h2 class="py-5 font-weight-light my-0">Made in Brooklyn, NY.</h2></div></footer></body></html>