<!doctype html><html><head><title>Interacting With Git via HTTP</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet href=../../../css/theme.css><link rel=stylesheet href=../../../css/syntax.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-56296045-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script async defer data-domain=willschenk.com src=https://plausible.io/js/plausible.js></script><meta property="og:title" content="Interacting With Git via HTTP"><meta property="og:description" content="Git continually impresses me. I've gone down a bit of a rabbit hole with how it works, and it's just a delight. I want to find a good way to see if a git repo changed, and I wonder if there's a way to do this using http directly, and there is. Investgation   First thing I did was to setup a proxy and run a git clone through it so I could see what the url is."><meta property="og:type" content="article"><meta property="og:url" content="https://willschenk.com/articles/2021/interacting_with_git_via_http/"><meta property="article:published_time" content="2021-02-11T00:00:00+00:00"><meta property="article:modified_time" content="2021-02-11T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Interacting With Git via HTTP"><meta name=twitter:description content="Git continually impresses me. I've gone down a bit of a rabbit hole with how it works, and it's just a delight. I want to find a good way to see if a git repo changed, and I wonder if there's a way to do this using http directly, and there is. Investgation   First thing I did was to setup a proxy and run a git clone through it so I could see what the url is."><meta name=twitter:site content="@wschenk"><style>.article p,.article ul,.article ol,.article table{max-width:45em}.article pre p{max-width:none;margin-top:-1.5rem}article.article p:first-child,.article blockquote{font-size:1.25em;font-weight:300;max-width:36em}.half-height-scroll{max-height:32em;overflow:scroll}</style></head><body><nav class="container my-5"><h1 class="pt-md-5 display-3"><a class=text-dark href=../../../>Will Schenk</a></h1><p><a class="text-dark h4 mr-3 font-weight-light" href=../../../articles/>Articles</a>
<a class="text-dark h4 mr-3 font-weight-light" href=../../../contact>Contact</a>
<a class="text-dark h4 mr-3 font-weight-light" href=../../../tags/>Tags</a>
<a href=../../../feed.xml class="mr-3 h4 text-light"><img src=../../../img/rss.svg alt=rss height=20 width=20></a>
<a href=https://twitter.com/@wschenk class="mr-3 h4 text-light"><img src=../../../img/twitter.svg alt=twitter height=20 width=20></a>
<a href=https://instagram.com/wschenk class="mr-3 h4 text-light"><img src=../../../img/instagram.svg alt=instagram height=20 width=20></a>
<a href=https://github.com/wschenk class="mr-3 h4 text-light"><img src=../../../img/github.svg alt=github height=20 width=20></a>
<a href=https://linkedin.com/in/will-schenk-420266 class="mr-3 h4 text-light"><img src=../../../img/linkedin.svg alt=linkedin height=20 width=20></a></p></nav><div class=container><h1 class=mt-5>Interacting With Git via HTTP</h1><h2 class="font-weight-light font-italic mb-3">Looking at git http traffic</h2><p class="text-muted mt-3"><a class=text-muted href=https://willschenk.com/articles/2021/interacting_with_git_via_http/>Published February 11, 2021</a>
<a class=text-muted href=../../../tags/git>#git</a></p><article class="article mt-5"><p>Git continually impresses me. I've gone down a bit of a rabbit hole
with how it works, and it's just a delight. I want to find a good way
to see if a git repo changed, and I wonder if there's a way to do this
using http directly, and there is.</p><h2 id=headline-1>Investgation</h2><p>First thing I did was to setup a proxy and run a git clone through it
so I could see what the url is.</p><h3 id=headline-2>First setup a proxy</h3><p>This will create a web proxy on <code class=verbatim>localhost:8080</code> with a ui on
<code class=verbatim>localhost:8081</code>. Once you kill this container everything cleans up.</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>  docker run --rm -it -p 8080:8080 -p 8081:8081 mitmproxy/mitmproxy mitmweb --web-host 0.0.0.0</code></pre></div></div><p>Open up <a href=http://localhost:8081>http://localhost:8081</a> to check it out.</p><h3 id=headline-3>Setup the test environment</h3><p>Since I'm going to be messing with my git config global state, lets
just spin up a throw away container so I don't need to worry about it
after. Also, install <code class=verbatim>git</code> in the environment.</p><p>We'll also set the <code class=verbatim>-global</code> config variables for <code class=verbatim>http.proxy</code> and
<code class=verbatim>http.sslVerify</code> to allow the mitm proxy to be accepted.</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>  docker run --rm -it --network host debian:10
  <span class=c1># You should be in the container now</span>
  apt-get update <span class=o>&amp;&amp;</span> apt-get install -y git

  git config --global http.proxy http://localhost:8080
  git config --global http.sslVerify false</code></pre></div></div><h3 id=headline-4>Then clone</h3><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>git clone https://github.com/wschenk/willschenk.com/</code></pre></div></div><p>Now we can see that</p><table class="table table-striped"><tbody><tr><td>request url</td><td>GET <a href="https://github.com/wschenk/willschenk.com/info/refs?service=git-upload-pack">https://github.com/wschenk/willschenk.com/info/refs?service=git-upload-pack</a> HTTP/2.0</td></tr><tr><td>user agent</td><td>git/2.20.1</td></tr><tr><td>accepts</td><td><strong><strong>/</strong></strong></td></tr></tbody></table><p>And it returns a binary file format of type
<code class=verbatim>application/x-git-upload-pack-advertisement</code></p><p>We can kill our docker containers, and save the file to start parsing!</p><p>Note that github anyway looks at the user agent to determine what to
serve, not the <code class=verbatim>Accept</code> header:</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>curl -H <span class=s2>&#34;Accept: */*&#34;</span> https://github.com/wschenk/willschenk.com/info/refs?service<span class=o>=</span>git-upload-pack</code></pre></div></div><pre class=example>
Not Found
</pre><p>So use <code class=verbatim>-A</code> to download the data.</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>  curl -A <span class=s2>&#34;git/2.20.1&#34;</span> --output ref.bin https://github.com/wschenk/willschenk.com/info/refs?service<span class=o>=</span>git-upload-pack
  ls -l ref.bin</code></pre></div></div><pre class=example>
-rw-r--r-- 1 wschenk wschenk 2223 Feb 11 16:55 ref.bin
</pre><h2 id=headline-5>Parsing the file</h2><p>Now that we have this binary file, we need to figure out how to read
it. Basically, file contains records with 4 byte headers telling how
long the each message is. We read the header, then those number of
bytes afterwards (hex count).</p><p>The first record also contains a null byte, which is a list of
capabitilities that the git server supports. One thing that's
interesting here is <code class=verbatim>symref=HEAD:refs/head/master</code> which is what tells
you what <code class=verbatim>HEAD</code> is pointing to. We'll look for that and seperate out
and print that line if needed.</p><div class="src src-ruby"><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby>  <span class=c1># Adapted from page 543 of Building Git</span>
  <span class=k>def</span> <span class=nf>recv_packet</span> <span class=n>input</span>
    <span class=n>head</span> <span class=o>=</span> <span class=n>input</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>head</span> <span class=k>unless</span> <span class=sr>/[0-9a-f]{4}/</span> <span class=o>=~</span> <span class=n>head</span>

    <span class=n>size</span> <span class=o>=</span> <span class=n>head</span><span class=o>.</span><span class=n>to_i</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
    <span class=k>return</span> <span class=kp>nil</span> <span class=k>if</span> <span class=n>size</span> <span class=o>==</span> <span class=mi>0</span>

    <span class=n>input</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>size</span> <span class=o>-</span> <span class=mi>4</span><span class=p>)</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=sr>/\n$/</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span>
  <span class=k>end</span>

  <span class=no>File</span><span class=o>.</span><span class=n>open</span><span class=p>(</span> <span class=s2>&#34;ref.bin&#34;</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span> <span class=p>)</span> <span class=k>do</span> <span class=o>|</span><span class=n>input</span><span class=o>|</span>
    <span class=k>while</span> <span class=o>!</span><span class=n>input</span><span class=o>.</span><span class=n>eof?</span>
      <span class=n>packet</span> <span class=o>=</span> <span class=n>recv_packet</span> <span class=n>input</span>
      <span class=k>if</span> <span class=n>packet</span>
        <span class=n>line</span><span class=p>,</span> <span class=n>options</span> <span class=o>=</span> <span class=n>packet</span><span class=o>.</span><span class=n>split</span><span class=p>(</span> <span class=s2>&#34;</span><span class=se>\0</span><span class=s2>&#34;</span><span class=p>,</span> <span class=mi>2</span> <span class=p>)</span>
        <span class=nb>puts</span> <span class=n>options</span> <span class=k>if</span> <span class=n>options</span>
        <span class=nb>puts</span> <span class=n>line</span>
      <span class=k>end</span>
    <span class=k>end</span>
  <span class=k>end</span></code></pre></div></div><p>Which returns</p><pre class="example half-height-scroll"># service=git-upload-pack
multi_ack thin-pack side-band side-band-64k ofs-delta shallow deepen-since deepen-not deepen-relative no-progress include-tag multi_ack_detailed allow-tip-sha1-in-want allow-reachable-sha1-in-want no-done symref=HEAD:refs/heads/master filter object-format=sha1 agent=git/github-g2ff1cad44179
847ea6126ee5f8ec5c4ad24e51b527face7a2979 HEAD
8fa8f73e7afa4564d6fb9d3788b71d06b705a98a refs/heads/askgit
e6a7c3f659b0da619ca3a9093084c57bd75705ca refs/heads/edit-effigy
614fa2058304444b2bcbbc963829c99252ecbb8e refs/heads/gh-pages
aaeb84f5c985786ed5905356325f37f5a7f136f2 refs/heads/hugo
b8dfbe29de07d79f115f5814df0981c592046e78 refs/heads/look-gemfiles
847ea6126ee5f8ec5c4ad24e51b527face7a2979 refs/heads/master
514bd4d82776edbb973576315fe5a479821a8fd7 refs/heads/tailwindedit
3c2ca082e7b8331a127afae2dec968d7cebc2ddf refs/meta/_netlify_cms
041b7a90c63d744418df2634d85d6f2d8974a9c8 refs/pull/1/head
03cee5d1d11a75e03b374c6d7600095332d4d178 refs/pull/10/head
e710ce9b944db4d418638ccaac4ade28b6f05bf8 refs/pull/11/head
d30312612ecdda3f46bc617c7167254ed6adcd6a refs/pull/12/head
25be0d44efb3cd2d890c5cbd151a84fb302efb16 refs/pull/13/head
5e8f6760d36c9a2cb6be656b68d82dc63ce91b61 refs/pull/14/head
e6a7c3f659b0da619ca3a9093084c57bd75705ca refs/pull/15/head
52b9dd7146cee391519307f64fa3b7039e54a2dc refs/pull/16/head
b93d017621b4324a5267b58cbd52a2b9ae2e2c0f refs/pull/17/head
8fa8f73e7afa4564d6fb9d3788b71d06b705a98a refs/pull/18/head
b8dfbe29de07d79f115f5814df0981c592046e78 refs/pull/19/head
a6bac7782c04514fe084449b27ec8eba9c794f7e refs/pull/2/head
d265bda5243b1ee0991cd241f52f7f9e908d1c72 refs/pull/20/head
dd032eab146ab1a8d15a406806f35da9a14f4842 refs/pull/3/head
54297948071e5531b1c0550b7e80f7af2b310db4 refs/pull/4/head
a3d591c21779b5ff9ecf5ee75f1e88ba37f9f11e refs/pull/5/head
4ff3703c2166bd4d7f5b123f90bb22da526dd3bc refs/pull/6/head
514bd4d82776edbb973576315fe5a479821a8fd7 refs/pull/7/head
2bbb09950d485304907850438cb381ddedc68aeb refs/pull/8/head
9eae9ff2e6f708ba605813ed4bb7bd6f3b8fbf23 refs/pull/9/head
9a843f070f3f11e09c689ba5c159fb261236029d refs/tags/middleman
</pre><h2 id=headline-6>Next steps</h2><p>This solves my use case because I can now compare the references to
the previously seen versions, and if they've changed do something
else. I would really recommend looking in deeper to see how the
object transfer protocol is implemented, it's pretty amazing how git
is put together.</p><h2 id=headline-7>References</h2><ol><li><p><a href=https://git-scm.com/book/en/v2/Git-Internals-Transfer-Protocols>https://git-scm.com/book/en/v2/Git-Internals-Transfer-Protocols</a></p></li><li><p><a href=https://git-scm.com/docs/protocol-common>https://git-scm.com/docs/protocol-common</a></p></li><li><p><a href=https://shop.jcoglan.com/building-git/>https://shop.jcoglan.com/building-git/</a></p></li><li><p><a href=https://gist.github.com/evantoli/f8c23a37eb3558ab8765>https://gist.github.com/evantoli/f8c23a37eb3558ab8765</a></p></li></ol></article></div><div class="bg-light py-5"><div class=container><h2 class=text-center>Read next</h2><div class=row><div class="col-md-6 text-center">Next Post:
<a href=../../../articles/2021/docker_one_liners/>Docker One Liners</a></div><div class="col-md-6 text-center">Previous Post:
<a href=../../../articles/2021/installing_faasd/>Installing faasd</a></div></div></div></div><div class="container mt-5"><h2 class=text-center>See also</h2><div class=row><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2020/release_code_diffs/>Release code diffs</a></p><p class="lead font-italic mb-0">What changes between releases</p><div class="font-weight-light mt-3"><p>When tracking and upgrading software you want to have an idea of what changed. Looking at the readme is helpful, and projects that keep a changelog are polite and friendly, but it's nice to actually get down to it and see what the changes actually are. Loading the repo and finding the tags We first need to look at where the code is from. In looking at gemfiles we found how to see what gem you are currently working with, and in looking and package.</p></div><a href=../../../articles/2020/release_code_diffs/ class="btn btn-primary">Read more</a></div><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2020/looking_at_packagejson/>Looking at package.json</a></p><p class="lead font-italic mb-0">making sense of package-lock.json</p><div class="font-weight-light mt-3"><p>Look at the dependencies First lets create a simple project and add a single module, in this case npm-api which will we use to access the main repository. npm init -y npm add npm-api And lets see what's been installed in node_modules: ls -l node_modules | wc -l du -sh node_modules 68 12M node_modules 68 directories with 12M of code!</p></div><a href=../../../articles/2020/looking_at_packagejson/ class="btn btn-primary">Read more</a></div><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2020/looking_at_gemfiles/>Looking at Gemfiles</a></p><p class="lead font-italic mb-0">making sense of Gemfile.lock</p><div class="font-weight-light mt-3"><p>Bundler is the standard way for Ruby projects to specifiy dependencies. Let's take a look at how that works, reimplement bundle outdated, and be able to see the changes that took place between the build you are using and the latest one. Ruby ecosystem: Rubygems, Bundler, Gemfile, Gemfile.lock rubygems is the overall ecosystem, which includes the main rubygems.org database of shared packages, and how they depend upon each other.</p></div><a href=../../../articles/2020/looking_at_gemfiles/ class="btn btn-primary">Read more</a></div></div></div><footer class="footer bg-dark text-light mt-3"><div class=container><h2 class="py-5 font-weight-light my-0">Made in Brooklyn, NY.</h2></div></footer></body></html>