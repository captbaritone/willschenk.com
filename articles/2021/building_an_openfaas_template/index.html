<!doctype html><html><head><title>Building static OpenFaas templates</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet href=../../../css/theme.css><link rel=stylesheet href=../../../css/syntax.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-56296045-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script async defer data-domain=willschenk.com src=https://plausible.io/js/plausible.js></script><meta property="og:title" content="Building static OpenFaas templates"><meta property="og:description" content="I've been playing with OpenFaaS recently and it's a very accessable way to starting building cloud first services. I wanted to see what I could cram in there, so I built a few templates that would let me host a static site. One that is just html, and another than can be built with something like create-react-app. Static   Create the template directory: mkdir -p template/static   Then add a template/static/template."><meta property="og:type" content="article"><meta property="og:url" content="https://willschenk.com/articles/2021/building_an_openfaas_template/"><meta property="article:published_time" content="2021-02-12T00:00:00+00:00"><meta property="article:modified_time" content="2021-02-12T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Building static OpenFaas templates"><meta name=twitter:description content="I've been playing with OpenFaaS recently and it's a very accessable way to starting building cloud first services. I wanted to see what I could cram in there, so I built a few templates that would let me host a static site. One that is just html, and another than can be built with something like create-react-app. Static   Create the template directory: mkdir -p template/static   Then add a template/static/template."><meta name=twitter:site content="@wschenk"><style>.article p,.article ul,.article ol,.article table{max-width:45em}.article pre p{max-width:none;margin-top:-1.5rem}article.article p:first-child,.article blockquote{font-size:1.25em;font-weight:300;max-width:36em}.half-height-scroll{max-height:32em;overflow:scroll}</style></head><body><nav class="container my-5"><h1 class="pt-md-5 display-3"><a class=text-dark href=../../../>Will Schenk</a></h1><p><a class="text-dark h4 mr-3 font-weight-light" href=../../../articles/>Articles</a>
<a class="text-dark h4 mr-3 font-weight-light" href=../../../contact>Contact</a>
<a class="text-dark h4 mr-3 font-weight-light" href=../../../tags/>Tags</a>
<a href=../../../feed.xml class="mr-3 h4 text-light"><img src=../../../img/rss.svg alt=rss height=20 width=20></a>
<a href=https://twitter.com/@wschenk class="mr-3 h4 text-light"><img src=../../../img/twitter.svg alt=twitter height=20 width=20></a>
<a href=https://instagram.com/wschenk class="mr-3 h4 text-light"><img src=../../../img/instagram.svg alt=instagram height=20 width=20></a>
<a href=https://github.com/wschenk class="mr-3 h4 text-light"><img src=../../../img/github.svg alt=github height=20 width=20></a>
<a href=https://linkedin.com/in/will-schenk-420266 class="mr-3 h4 text-light"><img src=../../../img/linkedin.svg alt=linkedin height=20 width=20></a></p></nav><div class=container><h1 class=mt-5>Building static OpenFaas templates</h1><h2 class="font-weight-light font-italic mb-3">Packaging up the packager</h2><p class="text-muted mt-3"><a class=text-muted href=https://willschenk.com/articles/2021/building_an_openfaas_template/>Published February 12, 2021</a>
<a class=text-muted href=../../../tags/openfaas>#openfaas,</a>
<a class=text-muted href=../../../tags/react>#react,</a>
<a class=text-muted href=../../../tags/static_sites>#static_sites</a></p><article class="article mt-5"><p>I've been playing with OpenFaaS recently and it's a very accessable
way to starting building cloud first services. I wanted to see what I
could cram in there, so I built a few templates that would let me host
a static site. One that is just html, and another than can be built
with something like <code class=verbatim>create-react-app</code>.</p><h2 id=headline-1>Static</h2><p>Create the <code class=verbatim>template</code> directory:</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>mkdir -p template/static</code></pre></div></div><p>Then add a <code class=verbatim>template/static/template.yml</code> file:</p><div class="src src-yml"><div class=highlight><pre class=chroma><code class=language-yml data-lang=yml><span class=k>language</span><span class=p>:</span><span class=w> </span>static<span class=w>
</span><span class=w></span><span class=k>handler_folder</span><span class=p>:</span><span class=w> </span>public</code></pre></div></div><p>Then add a <code class=verbatim>template/static/Dockerfile</code> to do the build:</p><div class="src src-dockerfile"><div class=highlight><pre class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=k>FROM</span><span class=s> --platform=${TARGETPLATFORM:-linux/amd64} openfaas/of-watchdog:0.7.2 as watchdog</span><span class=err>
</span><span class=err></span><span class=k>FROM</span><span class=s> --platform=${TARGETPLATFORM:-linux/amd64} alpine:3.10 AS runtime</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>WORKDIR</span><span class=s> /home/app</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>watchdog /fwatchdog .<span class=err>
</span><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>ENV</span> <span class=nv>mode</span><span class=o>=</span><span class=s2>&#34;static&#34;</span><span class=err>
</span><span class=err></span><span class=k>ENV</span> <span class=nv>static_path</span><span class=o>=</span><span class=s2>&#34;/home/app/public&#34;</span><span class=err>
</span><span class=err>
</span><span class=err>HEALTHCHECK --interval=3s </span><span class=k>CMD</span> <span class=p>[</span> <span class=err>-e</span> <span class=err>/tmp/.lock</span> <span class=p>]</span> <span class=o>||</span> <span class=nb>exit</span> <span class=m>1</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;./fwatchdog&#34;</span><span class=p>]</span></code></pre></div></div><h2 id=headline-2>Serving at root</h2><p>Setting up the <code class=verbatim>Caddyfile</code>:</p><div class="src src-caddyfile"><pre><code class=language-caddyfile data-lang=caddyfile>{
  email &#34;email@example.com&#34;
}

hostname.example.com {
  @proxy path /ui/* /system/* /function/*
  handle @proxy {
    reverse_proxy localhost:8080
  }

  handle {
    uri replace / /function/static/ 1
    reverse_proxy localhost:8080
  }
}</code></pre></div><p>This will proxy <code class=verbatim>/ui/*</code>, <code class=verbatim>/system/*</code>, and <code class=verbatim>/function/*</code> to the OpenFaaS
gateway, and everything else it will (internally) rewrite to
<code class=verbatim>/function/static/</code>, which will get forwarded our static handler. So
when you deploy the function make sure you name it that!</p><h2 id=headline-3>React</h2><p>First we need to create our <code class=verbatim>template</code> directory:</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>mkdir -p template/react</code></pre></div></div><p>First we need to create a <code class=verbatim>template/react/template.yml</code> file</p><div class="src src-yml"><div class=highlight><pre class=chroma><code class=language-yml data-lang=yml><span class=k>language</span><span class=p>:</span><span class=w> </span>react<span class=w>
</span><span class=w></span><span class=k>handler_folder</span><span class=p>:</span><span class=w> </span>react</code></pre></div></div><p><code class=verbatim>node_modules</code>, my least favorite thing in the world, needs to get
excluded, so lets create <code class=verbatim>template/react/.dockerignore</code>. The <code class=verbatim>react</code> here
must be the same as the <code class=verbatim>handler_folder</code> above.</p><div class="src src-yml"><div class=highlight><pre class=chroma><code class=language-yml data-lang=yml>react/node_modules<span class=w>
</span><span class=w></span>react/build</code></pre></div></div><p>Then we add the <code class=verbatim>Dockerfile</code> to build everything:</p><div class="src src-dockerfile"><div class=highlight><pre class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=k>FROM</span><span class=s> --platform=${TARGETPLATFORM:-linux/amd64} node:12-alpine as build</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>ARG</span> TARGETPLATFORM<span class=err>
</span><span class=err></span><span class=k>ARG</span> BUILDPLATFORM<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>RUN</span> apk --no-cache add curl ca-certificates <span class=se>\
</span><span class=se></span>    <span class=o>&amp;&amp;</span> addgroup -S app <span class=o>&amp;&amp;</span> adduser -S -g app app<span class=err>
</span><span class=err>
</span><span class=err></span><span class=c># Turn down the verbosity to default level.</span><span class=err>
</span><span class=err></span><span class=k>ENV</span> NPM_CONFIG_LOGLEVEL warn<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>RUN</span> mkdir -p /home/app<span class=err>
</span><span class=err>
</span><span class=err></span><span class=c># Build the react production build</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>WORKDIR</span><span class=s> /home/app</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>COPY</span> react/package.json react/yarn.lock ./<span class=err>
</span><span class=err>
</span><span class=err></span><span class=c># This ordering means the yarn installation is cached for the outer</span><span class=err>
</span><span class=err></span><span class=c># react handler.</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>RUN</span> yarn<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>COPY</span> react .<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>RUN</span> yarn build<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>FROM</span><span class=s> --platform=${TARGETPLATFORM:-linux/amd64} openfaas/of-watchdog:0.7.2 as watchdog</span><span class=err>
</span><span class=err></span><span class=k>FROM</span><span class=s> alpine:3.10 AS runtime</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>WORKDIR</span><span class=s> /home/app</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>build /home/app/build public<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>watchdog /fwatchdog .<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>ENV</span> <span class=nv>mode</span><span class=o>=</span><span class=s2>&#34;static&#34;</span><span class=err>
</span><span class=err></span><span class=k>ENV</span> <span class=nv>static_path</span><span class=o>=</span><span class=s2>&#34;/home/app/public&#34;</span><span class=err>
</span><span class=err>
</span><span class=err>HEALTHCHECK --interval=3s </span><span class=k>CMD</span> <span class=p>[</span> <span class=err>-e</span> <span class=err>/tmp/.lock</span> <span class=p>]</span> <span class=o>||</span> <span class=nb>exit</span> <span class=m>1</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;./fwatchdog&#34;</span><span class=p>]</span></code></pre></div></div><h3 id=headline-4>Testing React</h3><p>First we will create the function itself, and then populate it using
<code class=verbatim>npx create-react-app testappreact</code>. This will write it into the "handler"
directory.</p><p>We will also remove the <code class=verbatim>.git</code> repo that <code class=verbatim>create-react-app</code> sets up.</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>  faas-cli new --lang react testappreact
  npx create-react-app testappreact
  rm -rf testappreact/.git</code></pre></div></div><p>I recommend using relative links, by adding <code class=verbatim>"homepage": "./"</code> in the
generated <code class=verbatim>package.json</code> file.</p><p>Then we can build and deploy using</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>faas-cli up -f testappreact.yml</code></pre></div></div><p>And visit your server to see what you see!</p><h3 id=headline-5>Testing Vue app</h3><p>Just for fun, lets make it build a vue app.</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>  faas-cli new --lang react testappvue
  vue create testappvue
  rm -rf testappvue/.git</code></pre></div></div><p>In order to get vue apps to have relative paths, you need to create a
<code class=verbatim>vue.config.js</code> file to set it:</p><div class="src src-js"><div class=highlight><pre class=chroma><code class=language-js data-lang=js>  <span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=p>{</span>
      <span class=nx>publicPath</span><span class=o>:</span> <span class=s1>&#39;&#39;</span>
  <span class=p>};</span>
</code></pre></div></div><p>And since <code class=verbatim>vue</code> builds in the <code class=verbatim>dist</code> directory, we need to modify the
build script inside of <code class=verbatim>package.json</code> to rename the file after it's
built:</p><div class="src src-js"><div class=highlight><pre class=chroma><code class=language-js data-lang=js>    <span class=s2>&#34;build&#34;</span><span class=o>:</span> <span class=s2>&#34;vue-cli-service build &amp;&amp; mv dist build&#34;</span><span class=p>,</span>
</code></pre></div></div><p>Then, we can build and deploy:</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>  faas-cli up -f testappvue.yml</code></pre></div></div><p>It's a little hacky but it seems to work alright!</p><h2 id=headline-6>References</h2><ol><li><p><a href=https://github.com/openfaas/faas-cli/blob/master/guide/TEMPLATE.md>https://github.com/openfaas/faas-cli/blob/master/guide/TEMPLATE.md</a></p></li><li><p><a href=https://docs.openfaas.com/reference/yaml/#yaml-template-stack-configuration>https://docs.openfaas.com/reference/yaml/#yaml-template-stack-configuration</a></p></li><li><p><a href=https://medium.com/js-dojo/how-to-solve-vue-js-prod-build-assets-relative-path-problem-71f91138dd79>https://medium.com/js-dojo/how-to-solve-vue-js-prod-build-assets-relative-path-problem-71f91138dd79</a></p></li><li><p><a href=https://github.com/matipan/openfaas-hugo-template>https://github.com/matipan/openfaas-hugo-template</a></p></li></ol></article></div><div class="bg-light py-5"><div class=container><h2 class=text-center>Read next</h2><div class=row><div class="col-md-6 text-center">Next Post:
<a href=../../../articles/2021/uploading_blobs/>Uploading Blobs</a></div><div class="col-md-6 text-center">Previous Post:
<a href=../../../articles/2021/docker_one_liners/>Docker One Liners</a></div></div></div></div><div class="container mt-5"><h2 class=text-center>See also</h2><div class=row><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2020/simple_cors_workaround_for_local_development/>Simple CORS workaround for local development</a></p><div class="font-weight-light mt-3"><p>I've been doing a lot of web development old school, just editing HTML and JavaScript by hand without a build environment. Running npx live-server is an easy one liner to spin up a server, that opens a browser for you and also updates changes on safe. Sometimes that's not enough. Often you want to pull in data from an API, and that requires HTTPS, and also you need to work around CORS limitations.</p></div><a href=../../../articles/2020/simple_cors_workaround_for_local_development/ class="btn btn-primary">Read more</a></div><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2020/making_charts_with_vuejs_and_no_tooling/>Making charts with VueJS and no tooling</a></p><p class="lead font-italic mb-0">Static files all the way</p><div class="font-weight-light mt-3"><p>I learned most of what I know about coding by looking at source code &ndash; especially view source on a web browser. Lets see if we can bring that era back a bit by using ES modules and eschewing webpack and other bundling systems. We will use the amazing unpkg.com CDN to get our building blocks to assemble together.
First get vue working From unpkg we will link to tailwindcss in the head tag, and then import vuejs from using a script type="module" tag.</p></div><a href=../../../articles/2020/making_charts_with_vuejs_and_no_tooling/ class="btn btn-primary">Read more</a></div><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2018/implementing_serverless_oauth/>Implementing Serverless OAuth</a></p><p class="lead font-italic mb-0">for JAM Stacks and static sites</p><div class="font-weight-light mt-3"><p>Most of the serverless platforms have their own forms of authentication, but it might not support the specific service that you are looking to use. Lets go through how we can build a react single page app, hosting on firebase, that talks to the unsplash service directly. It will be hosted on firebase stoage, and with a tiny bit of firebase functions to tie it together.
How oauth works Here is the overall process:</p></div><a href=../../../articles/2018/implementing_serverless_oauth/ class="btn btn-primary">Read more</a></div></div></div><footer class="footer bg-dark text-light mt-3"><div class=container><h2 class="py-5 font-weight-light my-0">Made in Brooklyn, NY.</h2></div></footer></body></html>