<!doctype html><html><head><title>Using ActiveRecord outside of rails</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet href=../../../css/theme.css><link rel=stylesheet href=../../../css/syntax.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-56296045-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script async defer data-domain=willschenk.com src=https://plausible.io/js/plausible.js></script><meta property="og:title" content="Using ActiveRecord outside of rails"><meta property="og:description" content="Install dependancies  brew install postgres   Then bundle init bundle add activerecord pg activerecord rake  Rakefile   Rakefile: # From https://gist.github.com/Rhoxio/ee9a855088c53d447f2eb888bd9d09a4 require &#34;active_record&#34; require &#34;fileutils&#34; begin require 'dotenv/load' rescue LoadError end FileUtils.mkdir_p &#34;db/migrate&#34; namespace :db do include ActiveRecord::Tasks def db_config connection.db_config end def connection puts &#34;Database url #{ENV['DATABASE_URL']}&#34; @connection ||= ActiveRecord::Base.establish_connection end desc &#34;Create the database&#34; task :create do ActiveRecord::Tasks::DatabaseTasks.create db_config end desc &#34;Migrate the database&#34; task :migrate => [:create] do connection ActiveRecord::MigrationContext."><meta property="og:type" content="article"><meta property="og:url" content="https://willschenk.com/articles/2022/using_active_record_outside_of_rails/"><meta property="article:published_time" content="2022-01-02T00:00:00+00:00"><meta property="article:modified_time" content="2022-01-02T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using ActiveRecord outside of rails"><meta name=twitter:description content="Install dependancies  brew install postgres   Then bundle init bundle add activerecord pg activerecord rake  Rakefile   Rakefile: # From https://gist.github.com/Rhoxio/ee9a855088c53d447f2eb888bd9d09a4 require &#34;active_record&#34; require &#34;fileutils&#34; begin require 'dotenv/load' rescue LoadError end FileUtils.mkdir_p &#34;db/migrate&#34; namespace :db do include ActiveRecord::Tasks def db_config connection.db_config end def connection puts &#34;Database url #{ENV['DATABASE_URL']}&#34; @connection ||= ActiveRecord::Base.establish_connection end desc &#34;Create the database&#34; task :create do ActiveRecord::Tasks::DatabaseTasks.create db_config end desc &#34;Migrate the database&#34; task :migrate => [:create] do connection ActiveRecord::MigrationContext."><meta name=twitter:site content="@wschenk"><style>.article p,.article ul,.article ol,.article table{max-width:45em}.article pre p{max-width:none;margin-top:-1.5rem}article.article p:first-child,.article blockquote{font-size:1.25em;font-weight:300;max-width:36em}.half-height-scroll{max-height:32em;overflow:scroll}</style></head><body><nav class="container my-5"><h1 class="pt-md-5 display-3"><a class=text-dark href=../../../>Will Schenk</a></h1><p><a class="text-dark h4 mr-3 font-weight-light" href=../../../articles/>Articles</a>
<a class="text-dark h4 mr-3 font-weight-light" href=../../../contact>Contact</a>
<a class="text-dark h4 mr-3 font-weight-light" href=../../../tags/>Tags</a>
<a href=../../../feed.xml class="mr-3 h4 text-light"><img src=../../../img/rss.svg alt=rss height=20 width=20></a>
<a href=https://twitter.com/@wschenk class="mr-3 h4 text-light"><img src=../../../img/twitter.svg alt=twitter height=20 width=20></a>
<a href=https://instagram.com/wschenk class="mr-3 h4 text-light"><img src=../../../img/instagram.svg alt=instagram height=20 width=20></a>
<a href=https://github.com/wschenk class="mr-3 h4 text-light"><img src=../../../img/github.svg alt=github height=20 width=20></a>
<a href=https://linkedin.com/in/will-schenk-420266 class="mr-3 h4 text-light"><img src=../../../img/linkedin.svg alt=linkedin height=20 width=20></a></p></nav><div class=container><h1 class=mt-5>Using ActiveRecord outside of rails</h1><h2 class="font-weight-light font-italic mb-3">just the rake</h2><p class="text-muted mt-3"><a class=text-muted href=https://willschenk.com/articles/2022/using_active_record_outside_of_rails/>Published January 2, 2022</a>
<a class=text-muted href=../../../tags/activerecord>#activerecord,</a>
<a class=text-muted href=../../../tags/ruby>#ruby</a></p><article class="article mt-5"><h2 id=headline-1>Install dependancies</h2><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>  brew install postgres</code></pre></div></div><p>Then</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>  bundle init
  bundle add activerecord pg activerecord rake</code></pre></div></div><h2 id=headline-2><code class=verbatim>Rakefile</code></h2><p><a href=Rakefile>Rakefile</a>:</p><div class="src src-ruby"><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby>  <span class=c1># From https://gist.github.com/Rhoxio/ee9a855088c53d447f2eb888bd9d09a4</span>
  <span class=nb>require</span> <span class=s2>&#34;active_record&#34;</span>
  <span class=nb>require</span> <span class=s2>&#34;fileutils&#34;</span>
  <span class=k>begin</span>
    <span class=nb>require</span> <span class=s1>&#39;dotenv/load&#39;</span>
  <span class=k>rescue</span> <span class=no>LoadError</span>
  <span class=k>end</span>

  <span class=no>FileUtils</span><span class=o>.</span><span class=n>mkdir_p</span> <span class=s2>&#34;db/migrate&#34;</span>

  <span class=n>namespace</span> <span class=ss>:db</span> <span class=k>do</span>
    <span class=kp>include</span> <span class=no>ActiveRecord</span><span class=o>::</span><span class=no>Tasks</span>

    <span class=k>def</span> <span class=nf>db_config</span>
      <span class=n>connection</span><span class=o>.</span><span class=n>db_config</span>
    <span class=k>end</span>

    <span class=k>def</span> <span class=nf>connection</span>
      <span class=nb>puts</span> <span class=s2>&#34;Database url </span><span class=si>#{</span><span class=no>ENV</span><span class=o>[</span><span class=s1>&#39;DATABASE_URL&#39;</span><span class=o>]</span><span class=si>}</span><span class=s2>&#34;</span>

      <span class=vi>@connection</span> <span class=o>||=</span> <span class=no>ActiveRecord</span><span class=o>::</span><span class=no>Base</span><span class=o>.</span><span class=n>establish_connection</span>
    <span class=k>end</span>

    <span class=n>desc</span> <span class=s2>&#34;Create the database&#34;</span>
    <span class=n>task</span> <span class=ss>:create</span> <span class=k>do</span>
      <span class=no>ActiveRecord</span><span class=o>::</span><span class=no>Tasks</span><span class=o>::</span><span class=no>DatabaseTasks</span><span class=o>.</span><span class=n>create</span> <span class=n>db_config</span>
    <span class=k>end</span>


    <span class=n>desc</span> <span class=s2>&#34;Migrate the database&#34;</span>
    <span class=n>task</span> <span class=ss>:migrate</span> <span class=o>=&gt;</span> <span class=o>[</span><span class=ss>:create</span><span class=o>]</span> <span class=k>do</span>
      <span class=n>connection</span>
      <span class=no>ActiveRecord</span><span class=o>::</span><span class=no>MigrationContext</span><span class=o>.</span><span class=n>new</span><span class=p>(</span> <span class=s1>&#39;db/migrate&#39;</span> <span class=p>)</span><span class=o>.</span><span class=n>migrate</span>
      <span class=no>Rake</span><span class=o>::</span><span class=no>Task</span><span class=o>[</span><span class=s2>&#34;db:schema&#34;</span><span class=o>].</span><span class=n>invoke</span>
    <span class=k>end</span>

    <span class=n>desc</span> <span class=s2>&#34;Drop the database&#34;</span>
    <span class=n>task</span> <span class=ss>:drop</span> <span class=k>do</span>
      <span class=n>connection</span>
      <span class=no>ActiveRecord</span><span class=o>::</span><span class=no>Tasks</span><span class=o>::</span><span class=no>DatabaseTasks</span><span class=o>.</span><span class=n>drop</span> <span class=n>db_config</span>
    <span class=k>end</span>

    <span class=n>desc</span> <span class=s2>&#34;Reset the database&#34;</span>
    <span class=n>task</span> <span class=ss>:reset</span> <span class=o>=&gt;</span> <span class=o>[</span><span class=ss>:drop</span><span class=p>,</span> <span class=ss>:create</span><span class=p>,</span> <span class=ss>:migrate</span><span class=o>]</span>

    <span class=n>desc</span> <span class=s1>&#39;Create a db/schema.rb file that is portable against any DB supported by AR&#39;</span>
    <span class=n>task</span> <span class=ss>:schema</span> <span class=k>do</span>
      <span class=no>ActiveRecord</span><span class=o>::</span><span class=no>Tasks</span><span class=o>::</span><span class=no>DatabaseTasks</span><span class=o>.</span><span class=n>db_dir</span> <span class=o>=</span> <span class=s1>&#39;./db&#39;</span>
      <span class=no>ActiveRecord</span><span class=o>::</span><span class=no>Tasks</span><span class=o>::</span><span class=no>DatabaseTasks</span><span class=o>.</span><span class=n>dump_schema</span><span class=p>(</span> <span class=n>db_config</span> <span class=p>)</span>
    <span class=k>end</span>
  <span class=k>end</span>

  <span class=n>namespace</span> <span class=ss>:g</span> <span class=k>do</span>
    <span class=n>desc</span> <span class=s2>&#34;Generate migration&#34;</span>
    <span class=n>task</span> <span class=ss>:migration</span> <span class=k>do</span>
      <span class=nb>name</span> <span class=o>=</span> <span class=no>ARGV</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span> <span class=o>||</span> <span class=k>raise</span><span class=p>(</span><span class=s2>&#34;Specify name: rake g:migration your_migration&#34;</span><span class=p>)</span>
      <span class=n>timestamp</span> <span class=o>=</span> <span class=no>Time</span><span class=o>.</span><span class=n>now</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&#34;%Y%m%d%H%M%S&#34;</span><span class=p>)</span>
      <span class=n>path</span> <span class=o>=</span> <span class=no>File</span><span class=o>.</span><span class=n>expand_path</span><span class=p>(</span><span class=s2>&#34;../db/migrate/</span><span class=si>#{</span><span class=n>timestamp</span><span class=si>}</span><span class=s2>_</span><span class=si>#{</span><span class=nb>name</span><span class=si>}</span><span class=s2>.rb&#34;</span><span class=p>,</span> <span class=bp>__FILE__</span><span class=p>)</span>
      <span class=n>migration_class</span> <span class=o>=</span> <span class=nb>name</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;_&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=o>&amp;</span><span class=ss>:capitalize</span><span class=p>)</span><span class=o>.</span><span class=n>join</span>

      <span class=no>File</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span> <span class=k>do</span> <span class=o>|</span><span class=n>file</span><span class=o>|</span>
        <span class=n>file</span><span class=o>.</span><span class=n>write</span> <span class=s>&lt;&lt;-EOF
</span><span class=s></span>  <span class=k>class</span> <span class=c1>#{migration_class} &lt; ActiveRecord::Migration[6.0]</span>
    <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>up</span>
    <span class=k>end</span>

    <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>down</span>
    <span class=k>end</span>
  <span class=k>end</span>
        <span class=no>EOF</span>
      <span class=k>end</span>

      <span class=nb>puts</span> <span class=s2>&#34;Migration </span><span class=si>#{</span><span class=n>path</span><span class=si>}</span><span class=s2> created&#34;</span>
      <span class=nb>abort</span> <span class=c1># needed stop other tasks</span>
    <span class=k>end</span>
  <span class=k>end</span></code></pre></div></div><h2 id=headline-3>Now</h2><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>echo</span> rake -T</code></pre></div></div><pre class=example>
rake db:create    # Create the database
rake db:drop      # Drop the database
rake db:migrate   # Migrate the database
rake db:reset     # Reset the database
rake db:schema    # Create a db/schema.rb file that is portable against any DB supported by AR
rake g:migration  # Generate migration
</pre><h2 id=headline-4>References</h2><ol><li><p><a href=https://www.devdungeon.com/content/ruby-activerecord-without-rails-tutorial>https://www.devdungeon.com/content/ruby-activerecord-without-rails-tutorial</a></p></li></ol></article></div><div class="bg-light py-5"><div class=container><h2 class=text-center>Read next</h2><div class=row><div class="col-md-6 text-center">Next Post:
<a href=../../../articles/2022/snowpack_for_fast_builds/>Snowpack for fast builds</a></div><div class="col-md-6 text-center">Previous Post:
<a href=../../../articles/2021/pulling_avatars_from_slack/>Pulling avatars from slack</a></div></div></div></div><div class="container mt-5"><h2 class=text-center>See also</h2><div class=row><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2021/database_migrations/>Database Migrations</a></p><p class="lead font-italic mb-0">what should I do when not using rails</p><div class="font-weight-light mt-3"><p>Keeping track of database changes over time is best done using database migrations stored in a code repository. I'm working on something where programs in different languages will be access the same database, so here we are going to look at 3 different solutions to track changes that aren't tied to a specific framework. We're going to setup a postgres database – with pgadmin so we can see what's going on – and then do the same execersizes with 3 different ways to manage changes.</p></div><a href=../../../articles/2021/database_migrations/ class="btn btn-primary">Read more</a></div><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2015/receiving-posted-json-with-sinatra/>Receiving posted JSON with Sinatra</a></p><p class="lead font-italic mb-0">small tricks to make things easier</p><div class="font-weight-light mt-3"><p>Here&rsquo;s some simple code to accept a JSON string posted to a Sinatra end point rather than a form. I switched from using jQueries $.ajax method to superagent as part of my exploration of the node javascript package universe, and it has a different way of serializing nest objects when posting as a form. Specifically, it doesn&rsquo;t.
I needed something that could do both.
Code to use form encoding or JSON blob This first tries and loads the parameters using the normal form encoding methods.</p></div><a href=../../../articles/2015/receiving-posted-json-with-sinatra/ class="btn btn-primary">Read more</a></div><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2015/adding-search-to-a-middleman-blog/>Adding search to a middleman blog</a></p><p class="lead font-italic mb-0">slightly simplier than google</p><div class="font-weight-light mt-3"><p>We&rsquo;re going to build a simple, niave search for middleman blogs. We&rsquo;re going to build a search index at build time, and then use that index to perform the search itself on the client side.
Building the index When you typed in something in google, it doesn&rsquo;t then go and hit every page on the internet to check to see if there&rsquo;s a match. It doesn&rsquo;t even look at every page that it has squirreled away somewhere in the googleplex.</p></div><a href=../../../articles/2015/adding-search-to-a-middleman-blog/ class="btn btn-primary">Read more</a></div></div></div><footer class="footer bg-dark text-light mt-3"><div class=container><h2 class="py-5 font-weight-light my-0">Made in Brooklyn, NY.</h2></div></footer></body></html>